<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TG üí≤VadminLink</title>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
            --shadow: 222.2 84% 4.9%;
            --success: 120 99% 38%;
            --warning: 45 100% 50%;
            --info: 210 100% 50%;
            --surface: 0 0% 100%;
            --surface-elevated: 0 0% 98%;
            --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.08);
            --shadow-strong: 0 18px 45px rgba(15, 23, 42, 0.14);
            --ring-shadow: 0 0 0 3px hsl(var(--ring) / 0.25);
            color-scheme: light;
        }

        :root.dark-theme {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 216 12% 17%;
            --card-foreground: 210 40% 98%;
            --popover: 216 12% 17%;
            --popover-foreground: 210 40% 98%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 216 10% 25%;
            --secondary-foreground: 210 40% 98%;
            --muted: 216 10% 25%;
            --muted-foreground: 215.4 16.3% 66.9%;
            --accent: 216 10% 25%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 216 10% 30%;
            --input: 216 10% 30%;
            --ring: 221.2 83.2% 53.3%;
            --shadow: 222.2 84% 4.9%;
            --success: 120 99% 38%;
            --warning: 45 100% 50%;
            --info: 210 100% 50%;
            --surface: 216 12% 14%;
            --surface-elevated: 216 12% 18%;
            --shadow-soft: 0 10px 24px rgba(2, 8, 23, 0.4);
            --shadow-strong: 0 22px 50px rgba(2, 8, 23, 0.55);
            --ring-shadow: 0 0 0 3px hsl(var(--ring) / 0.35);
            color-scheme: dark;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(1200px 800px at 10% 10%, hsl(var(--primary) / 0.25), transparent 60%),
                radial-gradient(900px 700px at 90% 0%, hsl(var(--info) / 0.22), transparent 55%),
                linear-gradient(180deg, hsl(var(--background)), hsl(var(--muted)));
            color: hsl(var(--foreground));
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            background-attachment: fixed;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)));
            z-index: 9999;
            transition: background 0.3s ease;
        }

        .login-container.hidden {
            display: none;
        }

        .login-card {
            background: hsl(var(--card) / 0.92);
            border: 1px solid hsl(var(--border) / 0.8);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-strong);
            width: 100%;
            max-width: 400px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .login-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .login-card h1 {
            color: hsl(var(--foreground));
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-card p {
            color: hsl(var(--muted-foreground));
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-form-group {
            margin-bottom: 1.5rem;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            font-weight: 500;
            font-size: 0.875rem;
        }

        .login-form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid hsl(var(--input));
            border-radius: var(--radius);
            font-size: 1rem;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .login-alert {
            display: none;
            padding: 0.75rem;
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border: 1px solid hsl(var(--destructive) / 0.2);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .login-alert.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0.75rem 0.5rem 0.5rem;
        }

        .main-app {
            min-height: 100vh;
        }

        header {
            text-align: center;
            color: hsl(var(--foreground));
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            border-radius: calc(var(--radius) * 1.5);
            border: 1px solid hsl(var(--border) / 0.8);
            background: hsl(var(--card) / 0.85);
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(12px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        header h1 {
            font-size: 1.75rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-toggle {
            position: relative;
            z-index: 10;
        }

        .icon-btn {
            background: hsl(var(--secondary) / 0.9);
            border: 1px solid hsl(var(--border) / 0.8);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: hsl(var(--secondary-foreground));
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: hsl(var(--accent));
        }

        .logout-btn {
            background: hsl(var(--secondary) / 0.9);
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border) / 0.8);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: hsl(var(--accent));
        }

        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card {
            background: hsl(var(--card) / 0.9);
            border: 1px solid hsl(var(--border) / 0.7);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            backdrop-filter: blur(8px);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .card-header {
            padding: 1rem;
            border-bottom: 2px solid hsl(var(--primary));
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .card-header h2 {
            color: hsl(var(--foreground));
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header-icon {
            transition: transform 0.3s ease;
        }

        .card-header.collapsed .card-header-icon {
            transform: rotate(-90deg);
        }

        .card-content {
            padding: 0 1rem;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .card-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-hint {
            color: hsl(var(--muted-foreground));
            font-size: 0.8125rem;
            margin-top: 0.3125rem;
            display: block;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid hsl(var(--input) / 0.85);
            border-radius: var(--radius);
            font-size: 1rem;
            background: hsl(var(--background) / 0.9);
            color: hsl(var(--foreground));
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: var(--ring-shadow);
        }

        textarea {
            resize: vertical;
            min-height: 6rem;
            font-family: 'Courier New', monospace;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        .btn-secondary:hover {
            background: hsl(var(--accent));
        }

        .btn-danger {
            background: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .btn-danger:hover {
            background: hsl(var(--destructive) / 0.9);
        }

        .btn-test {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-test:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid hsl(var(--border));
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            min-width: auto;
        }

        .btn-success {
            background: hsl(var(--success));
            color: white;
        }

        .btn-warning {
            background: hsl(var(--warning));
            color: white;
        }

        .btn-info {
            background: hsl(var(--info));
            color: white;
        }

        .rules-list {
            max-height: 37.5rem;
            overflow-y: auto;
            padding: 0.5rem;
        }

        #rules-tab .content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #rules-tab .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #rules-tab .rules-layout {
            flex: 1;
            min-height: 0 !important;
        }

        #rules-tab .rules-list {
            max-height: none !important;
            height: 100%;
        }

        #rules-tab .rules-list-column,
        #rules-tab .rules-details-column {
            height: 100%;
        }

        .rule-item {
            background: hsl(var(--muted));
            border-left: 4px solid hsl(var(--primary));
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .rule-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rule-item.disabled {
            opacity: 0.6;
            border-left-color: hsl(var(--muted-foreground));
        }

        .rule-item.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .rule-content {
            flex: 1;
        }

        .rule-name {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-condition {
            background: hsl(var(--background));
            padding: 0.625rem;
            border-radius: calc(var(--radius) - 2px);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.5rem;
            word-break: break-word;
            border: 1px solid hsl(var(--border));
        }

        .rule-channel {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        .rule-bot {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .rule-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 120px;
        }

        .rule-status {
            display: flex;
            gap: 5px;
            align-items: center;
            font-size: 0.85em;
            margin-top: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
        }

        .status-badge.disabled {
            background: #999;
        }

        .alert {
            padding: 1rem;
            border-radius: calc(var(--radius) - 2px);
            margin-bottom: 1rem;
            display: none;
            border: 1px solid hsl(var(--border));
            animation: fadeIn 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: hsl(var(--success) / 0.15);
            color: hsl(var(--success));
            border-color: hsl(var(--success) / 0.3);
        }

        .alert-error {
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border-color: hsl(var(--destructive) / 0.3);
        }

        .alert-info {
            background: hsl(var(--info) / 0.1);
            color: hsl(var(--info));
            border-color: hsl(var(--info) / 0.3);
        }

        .alert-warning {
            background: hsl(var(--warning) / 0.1);
            color: hsl(var(--warning));
            border-color: hsl(var(--warning) / 0.3);
        }

        .instructions {
            background: hsl(var(--muted));
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: hsl(var(--shadow) / 0.1) 0px 4px 6px -1px, hsl(var(--shadow) / 0.1) 0px 2px 4px -2px;
            color: hsl(var(--foreground));
            margin-top: 1rem;
        }

        .instructions h3 {
            color: hsl(var(--primary));
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instructions h3:first-child {
            margin-top: 0;
        }

        .instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }

        .dark-theme .instructions code {
            background: #444;
            color: #ff7070;
        }

        .instructions pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .dark-theme .instructions pre {
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .instructions ul,
        .instructions ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .webhook-url {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .dark-theme .webhook-url {
            background: #333;
            border-color: #555;
            color: #fff;
        }

        .test-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid hsl(var(--border));
        }

        .test-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            display: none;
            border-left: 4px solid #6c757d;
        }

        .dark-theme .test-result {
            background: #333;
            color: #fff;
        }

        .test-result.success {
            border-left-color: hsl(var(--success));
        }

        .test-result.error {
            border-left-color: hsl(var(--destructive));
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: hsl(var(--card) / 0.95);
            border-radius: var(--radius);
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            border: 1px solid hsl(var(--border) / 0.7);
            backdrop-filter: blur(12px);
        }

        .modal-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid hsl(var(--border));
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Tabs styles */
        .tabs-container {
            margin-bottom: 0;
            display: flex;
            gap: 1rem;
            align-items: stretch;
            width: 100%;
            flex: 1;
            min-height: 0;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            background: hsl(var(--card) / 0.85);
            border: 1px solid hsl(var(--border) / 0.7);
            border-radius: calc(var(--radius) * 1.5);
            padding: 0.3rem 0.5rem;
            width: auto;
            min-width: auto;
            max-width: fit-content;
            box-shadow: var(--shadow-soft);
            align-self: stretch;
            justify-content: flex-start;
            height: 100%;
        }

        .tab {
            padding: 0.25rem 0.65rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: calc(var(--radius) * 1.2);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.45rem;
            text-align: left;
            width: fit-content;
            font-size: 0.875rem;
        }

        .tab svg {
            width: 14px;
            height: 14px;
        }

        .tab:hover {
            background: hsl(var(--accent) / 0.8);
            border-color: hsl(var(--border) / 0.6);
        }

        .tab.active {
            background: hsl(var(--card));
            border-color: hsl(var(--border) / 0.8);
            box-shadow: inset 3px 0 0 hsl(var(--primary));
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: hsl(var(--card) / 0.9);
            border-radius: calc(var(--radius) * 1.25);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        th,
        td {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid hsl(var(--border) / 0.6);
            text-align: left;
            vertical-align: top;
        }

        thead th {
            background: hsl(var(--secondary) / 0.8);
            color: hsl(var(--secondary-foreground));
            font-weight: 600;
        }

        tbody tr:hover {
            background: hsl(var(--accent) / 0.5);
        }

        button:focus-visible,
        .icon-btn:focus-visible,
        .logout-btn:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: none;
            box-shadow: var(--ring-shadow);
        }

        .tab-content {
            position: relative;
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .tab-content > .tab-pane.active {
            flex: 1;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
            height: 100%;
        }

        /* Rules toolbar styles */
        .rules-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0 0.5rem;
        }

        .rules-toolbar h2 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .rules-search {
            position: relative;
            width: 250px;
        }

        .rules-search input {
            padding-left: 2.5rem;
        }

        .rules-search::before {
            content: "üîç";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: hsl(var(--muted-foreground));
            font-size: 1rem;
        }

        /* Create rule button */
        .create-rule-btn {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .create-rule-btn:hover {
            background: hsl(var(--primary) / 0.9);
            transform: translateY(-1px);
        }

        /* Logs styles */
        .logs-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logs-toolbar h2 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .logs-actions {
            display: flex;
            gap: 0.75rem;
        }

        .logs-container {
            max-height: 40rem;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .log-item {
            border-bottom: 1px solid hsl(var(--border));
            padding: 0.625rem 0;
            color: hsl(var(--foreground));
        }

        .log-timestamp {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
        }

        .log-payload {
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            padding: 0.5rem;
            margin: 0.3125rem 0;
            font-size: 0.875rem;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            max-height: 15rem;
            overflow: auto;
        }

        .log-match {
            margin-top: 0.3125rem;
            font-weight: 500;
        }

        .log-telegram {
            margin-top: 0.3125rem;
        }

        .log-telegram-item {
            margin: 0.25rem 0;
            padding-left: 1.25rem;
        }

        .log-success {
            color: hsl(var(--success));
        }

        .log-error {
            color: hsl(var(--destructive));
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .page-btn {
            background: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: hsl(var(--accent));
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        /* Condition builder */
        .condition-builder {
            background: hsl(var(--muted));
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .condition-mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .condition-mode-toggle label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .condition-groups {
            margin-bottom: 1.5rem;
        }

        .condition-group {
            background: hsl(var(--background));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .condition-rows {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .condition-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .condition-row select, 
        .condition-row input {
            flex: 1;
            min-width: 150px;
        }

        .add-condition-btn {
            background: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-condition-btn:hover {
            background: hsl(var(--accent));
        }

        .remove-condition-btn {
            background: hsl(var(--destructive));
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0;
        }

        .condition-logic {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .preview-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid hsl(var(--primary));
        }

        .preview-result {
            background: hsl(var(--background));
            border-radius: calc(var(--radius) - 2px);
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            border: 1px solid hsl(var(--border));
        }

        .telegram-preview {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            overflow: hidden;
            background: #eaeaea;
            max-width: 400px;
            margin: 0 auto;
        }

        .telegram-message {
            display: flex;
            padding: 0.75rem;
            background: white;
        }

        .telegram-avatar {
            width: 40px;
            height: 40px;
            background: #0088cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .telegram-content {
            flex: 1;
        }

        .telegram-sender {
            font-weight: 600;
            color: #000;
            margin-bottom: 0.25rem;
        }

        .telegram-text {
            color: #333;
            line-height: 1.5;
            font-size: 0.9375rem;
            white-space: pre-line;
        }

        .telegram-time {
            color: #999;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .code-condition-editor {
            margin-top: 1rem;
        }

        /* Input with button */
        .input-with-button {
            position: relative;
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button button {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            padding: 0;
        }

        /* Export/import section */
        .export-import-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid hsl(var(--border));
        }

        .export-import-section h3 {
            margin-top: 0;
            color: hsl(var(--primary));
            border: none;
            padding: 0;
        }

        .skeleton {
            background: linear-gradient(90deg, 
                hsl(var(--muted)) 0%, 
                hsl(var(--muted) / 0.8) 50%, 
                hsl(var(--muted)) 100%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
                position: static;
            }

            header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
                width: 100%;
                min-width: 0;
            }

            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                justify-content: center;
                flex: 1 1 160px;
            }

            .tabs-container {
                min-height: auto;
            }

            .rules-toolbar, .logs-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .rules-search {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
            }

            .rule-item {
                flex-direction: column;
            }

            .rule-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .condition-row {
                flex-direction: column;
                align-items: stretch;
            }

            .telegram-preview {
                max-width: 100%;
            }
            
            .create-rule-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1>üîê –í—Ö–æ–¥</h1>
            <p>–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TG</p>

            <div id="loginAlert" class="login-alert"></div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label for="username">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="username" placeholder="login" required>
                </div>

                <div class="login-form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" placeholder="password" required>
                </div>

                <button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <h1>üì± –ò–Ω—Ç—Ä–µ–≥—Ä–∞—Ü–∏—è —Å TG üí≤VadminLink</h1>
                <div class="header-actions">
                    <span id="currentUsername" style="margin-right: 1rem; color: hsl(var(--muted-foreground));"></span>
                    <button class="logout-btn" onclick="showChangePasswordModal()" style="margin-right: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                    <div class="theme-toggle">
                        <button id="themeToggle" class="icon-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </button>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        –í—ã—Ö–æ–¥
                    </button>
                </div>
            </header>

            <!-- Modal for change password -->
            <div id="changePasswordModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2>
                        <button class="icon-btn" onclick="closeChangePasswordModal()" style="margin-left: auto;">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div id="changePasswordAlert" class="alert"></div>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label for="oldPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="oldPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label for="newPasswordChange">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="newPasswordChange" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                                <button type="button" class="btn-secondary" onclick="closeChangePasswordModal()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="rules">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                        </svg>
                        –ü—Ä–∞–≤–∏–ª–∞
                    </button>
                    <button class="tab" data-tab="test">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </button>
                    <button class="tab" data-tab="history">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="12 6 12 12 16 14"></polyline>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        –ò—Å—Ç–æ—Ä–∏—è
                    </button>
                    <button class="tab" data-tab="queue">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
                    </button>
                    <button class="tab" data-tab="users" id="usersTab" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </button>
                </div>
                
                <div class="tab-content">
                    <div id="rules-tab" class="tab-pane active">
                        <div class="content">
                            <div class="card">
                                <div class="rules-toolbar">
                                    <h2>üìã –ü—Ä–∞–≤–∏–ª–∞</h2>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <div class="rules-search">
                                            <input type="text" id="rulesSearch" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∏–ª...">
                                        </div>
                                        <button class="btn-secondary btn-small" onclick="showExportImportModal()" title="–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7,10 12,15 17,10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                        </button>
                                        <button class="btn-secondary btn-small" id="toggleSettingsBtn" onclick="showInstructionsModal()" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M12 16v-4"></path>
                                                <path d="M12 8h.01"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="rulesAlert" class="alert"></div>
                                
                                <input type="file" id="importFile" accept=".json" style="display: none;">

                                <div class="rules-layout" style="display: flex; gap: 1rem; min-height: 500px;">
                                    <div class="rules-list-column" style="flex: 0 0 500px; border-right: 1px solid hsl(var(--border)); padding-right: 1rem;">
                                        <div id="rulesList" class="rules-list" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                                            <p style="color: hsl(var(--muted-foreground)); text-align: center; padding: 40px 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...</p>
                                        </div>
                                    </div>
                                    
                                    <div class="rules-details-column" style="flex: 1; padding-left: 1rem;">
                                        <div id="ruleDetails" style="display: none;">
                                            <div id="ruleDetailsView" style="display: none;">
                                                <h3 style="margin-top: 0;">–î–µ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª–∞</h3>
                                                <div id="ruleDetailsContent"></div>
                                            </div>
                                            <div id="ruleFormContainer" style="display: none;">
                                                <div id="addAlert" class="alert"></div>
                                                <form id="ruleForm">
                                                <div class="form-group">
                                                    <label for="ruleName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</label>
                                                    <input type="text" id="ruleName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç" required>
                                                    <small class="form-hint">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</small>
                                                </div>

                                                <div class="form-group">
                                                    <label for="condition">–£—Å–ª–æ–≤–∏–µ (JavaScript –≤—ã—Ä–∞–∂–µ–Ω–∏–µ)</label>
                                                    <div class="condition-builder">
                                                        <div class="condition-mode-toggle">
                                                            <label>
                                                                <input type="radio" name="conditionMode" value="visual" checked>
                                                                –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                                                            </label>
                                                            <label>
                                                                <input type="radio" name="conditionMode" value="code">
                                                                –†—É—á–Ω–æ–π –≤–≤–æ–¥ (JavaScript)
                                                            </label>
                                                        </div>
                                                        
                                                        <div class="visual-condition-editor" id="visualConditionEditor">
                                                            <div class="condition-groups">
                                                                <div class="condition-group">
                                                                    <div class="condition-rows">
                                                                        <div class="condition-row">
                                                                            <select class="field-select">
                                                                                <option value="payload.team_id">ID –∫–æ–º–∞–Ω–¥—ã</option>
                                                                                <option value="payload.team.name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</option>
                                                                                <option value="payload.status">–°—Ç–∞—Ç—É—Å</option>
                                                                                <option value="payload.category" selected>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                                                                <option value="payload.impact">–í–ª–∏—è–Ω–∏–µ</option>
                                                                                <option value="payload.priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                                                                                <option value="payload.requested_by.name">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</option>
                                                                            </select>
                                                                            <select class="operator-select">
                                                                                <option value="===" selected>—Ä–∞–≤–Ω–æ</option>
                                                                                <option value="!==">–Ω–µ —Ä–∞–≤–Ω–æ</option>
                                                                                <option value=">">–±–æ–ª—å—à–µ</option>
                                                                                <option value="<">–º–µ–Ω—å—à–µ</option>
                                                                                <option value="includes">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                                                                            </select>
                                                                            <input type="text" class="value-input" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="incident">
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="add-condition-btn">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                                                        </svg>
                                                                        –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="condition-logic">
                                                                <label>
                                                                    <input type="radio" name="groupLogic" value="AND" checked>
                                                                    –ò (AND) - –≤—Å–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
                                                                </label>
                                                                <label>
                                                                    <input type="radio" name="groupLogic" value="OR">
                                                                    –ò–õ–ò (OR) - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è
                                                                </label>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="code-condition-editor" id="codeConditionEditor" style="display: none;">
                                                            <textarea id="conditionCode" placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: payload.category === "incident" && payload.impact === "high"'>payload.category === "incident"</textarea>
                                                            <small class="form-hint">–î–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è <code>payload</code> —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–µ–±—Ö—É–∫–∞</small>
                                                        </div>
                                                        
                                                        <div class="preview-section">
                                                            <h3>üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —É—Å–ª–æ–≤–∏—è</h3>
                                                            <div class="preview-result">
                                                                <strong>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:</strong>
                                                                <pre id="conditionPreview">payload.category === "incident"</pre>
                                                            </div>
                                                            
                                                            <input type="hidden" id="condition" value='payload.category === "incident"'>
                                                            
                                                            <h3>üì± –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                                                            <div class="telegram-preview">
                                                                <div class="telegram-message">
                                                                    <div class="telegram-avatar">ü§ñ</div>
                                                                    <div class="telegram-content">
                                                                        <div class="telegram-sender">Webhook Bot</div>
                                                                        <div class="telegram-text" id="messagePreview">
                                                                            üÜî ID: 141<br><br>
                                                                            üìã –¢–µ–º–∞: –ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è<br><br>
                                                                            üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞: –ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è @–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç<br><br>
                                                                            –ö–æ–º–∞–Ω–¥–∞: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
                                                                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: incident<br>
                                                                            –í–ª–∏—è–Ω–∏–µ: medium<br><br>
                                                                            üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:<br>
                                                                            1. –ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π @–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç (07.01.2026, 16:36): avwqrgw
                                                                        </div>
                                                                        <div class="telegram-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group">
                                                    <label for="chatId">ID Telegram —á–∞—Ç–∞</label>
                                                    <input type="text" id="chatId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890" required>
                                                    <small class="form-hint">–î–ª—è –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.</small>
                                                </div>

                                                <div class="form-group">
                                                    <label for="botToken">–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                                    <div class="input-with-button">
                                                        <input type="password" id="botToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" required>
                                                        <button type="button" class="toggle-password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
                                                    </div>
                                                    <small class="form-hint">–ü–æ–ª—É—á–∏—Ç–µ –æ—Ç @BotFather –≤ Telegram. –ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞.</small>
                                                </div>

                                                <div class="form-group">
                                                    <label for="messageTemplate">–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                                    <textarea id="messageTemplate" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª–Ω–æ–≥–æ payload"></textarea>
                                                    <small class="form-hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>${'{payload}'}</code> –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω.</small>
                                                </div>

                                                <div class="form-group checkbox-group">
                                                    <input type="checkbox" id="enabled" checked>
                                                    <label for="enabled" style="margin: 0;">–í–∫–ª—é—á–µ–Ω–æ</label>
                                                </div>

                                                <div class="button-group">
                                                    <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
                                                    <button type="reset" class="btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                                </div>
                                            </form>
                                            </div>
                                        </div>
                                        <div id="ruleDetailsPlaceholder" style="color: hsl(var(--muted-foreground)); text-align: center; padding: 2rem;">
                                            <p style="margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                                            <button class="btn-primary" onclick="createNewRule()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="test-tab" class="tab-pane">
                        <div class="content">
                            <div class="card">
                                <h2>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π</h2>
                                <div class="form-group">
                                    <label for="testCondition">–£—Å–ª–æ–≤–∏–µ</label>
                                    <input type="text" id="testCondition" placeholder='payload.team_id === 40' value='payload.category === "incident"'>
                                </div>
                                <div class="form-group">
                                    <label for="testPayload">–¢–µ—Å—Ç–æ–≤—ã–π payload (JSON)</label>
                                    <textarea id="testPayload" placeholder='{"team_id": 40, "name": "Test"}'>{
  "team_id": 40,
  "team": {
    "id": 40,
    "name": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  },
  "category": "incident",
  "impact": "medium",
  "subject": "–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è",
  "requested_by": {
    "name": "–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è",
    "account": {
      "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
    }
  },
  "note": [
    {
      "text": "avwqrgw",
      "person": {
        "name": "–ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π"
      },
      "account": {
        "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
      },
      "created_at": "2026-01-07T16:36:27Z"
    }
  ],
  "resolution_target_at": "2024-07-29T19:20:00Z",
  "response_target_at": "2024-07-26T21:50:00Z"
}</textarea>
                                    <small class="form-hint">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä payload –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>
                                </div>
                                <button class="btn-test" onclick="testCondition()">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–∏–µ</button>
                                <div id="testResult" class="test-result"></div>
                            </div>
                            
                            <div class="card">
                                <h2>üì§ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram</h2>
                                <div class="form-group">
                                    <label for="testBotToken">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                                    <div class="input-with-button">
                                        <input type="password" id="testBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                                        <button type="button" class="toggle-password-test" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
                                    </div>
                                    <small class="form-hint">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–∞–≤–∏–ª –±–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</small>
                                    <button class="btn-secondary btn-small" onclick="saveTestBotToken()" style="margin-top: 0.5rem;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω</button>
                                </div>
                                <div class="form-group">
                                    <label for="testChatId">ID —á–∞—Ç–∞</label>
                                    <input type="text" id="testChatId" placeholder="-1001234567890">
                                    <small class="form-hint">ID —á–∞—Ç–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª–∞ –≤ Telegram</small>
                                </div>
                                <div class="form-group">
                                    <label for="testMessage">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                                    <textarea id="testMessage" placeholder="–ü—Ä–∏–≤–µ—Ç –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</textarea>
                                </div>
                                <button class="btn-primary" onclick="testTelegramSend()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                                <div id="telegramTestResult" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <div id="history-tab" class="tab-pane">
                        <div class="card">
                            <div class="logs-toolbar">
                                <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –≤–µ–±—Ö—É–∫–æ–≤</h2>
                                <div class="logs-actions">
                                    <button class="btn-secondary" onclick="loadWebhookLogs()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                        </svg>
                                        –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                    <button class="btn-danger" onclick="clearWebhookLogs()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                        –û—á–∏—Å—Ç–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            
                            <div id="logsAlert" class="alert"></div>
                            
                            <div class="logs-layout" style="display: flex; gap: 1rem; min-height: 500px;">
                                <div class="logs-list" style="flex: 0 0 400px; border-right: 1px solid hsl(var(--border)); padding-right: 1rem;">
                                    <div id="logsContainer" class="logs-container skeleton" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                                        <p style="color: hsl(var(--muted-foreground)); text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                                    </div>
                                    
                                    <div class="pagination" style="margin-top: 1rem;">
                                        <button class="page-btn prev" disabled>‚Üê –ü—Ä–µ–¥</button>
                                        <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
                                        <button class="page-btn next" disabled>–°–ª–µ–¥ ‚Üí</button>
                                    </div>
                                </div>
                                
                                <div class="logs-details" style="flex: 1; padding-left: 1rem;">
                                    <div id="logDetails" style="display: none;">
                                        <h3 style="margin-top: 0;">–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                                        <div id="logDetailsContent"></div>
                                    </div>
                                    <div id="logDetailsPlaceholder" style="color: hsl(var(--muted-foreground)); text-align: center; padding: 2rem;">
                                        –í—ã–±–µ—Ä–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="queue-tab" class="tab-pane">
                        <div class="content">
                            <div class="card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h2>üì¨ –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <select id="queueStatusFilter" style="padding: 0.5rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); background: hsl(var(--background));">
                                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                                            <option value="processing">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</option>
                                            <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                            <option value="failed">–û—à–∏–±–∫–∞</option>
                                        </select>
                                        <button class="btn-primary" onclick="loadQueueHistory()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                                    </div>
                                </div>
                                
                                <div id="queueAlert" class="alert"></div>
                                
                                <div id="queueStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                                        <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.25rem;">–í—Å–µ–≥–æ</div>
                                        <div style="font-size: 1.5rem; font-weight: 600;" id="queueTotal">-</div>
                                    </div>
                                    <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                                        <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.25rem;">–û–∂–∏–¥–∞–µ—Ç</div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #f59e0b;" id="queuePending">-</div>
                                    </div>
                                    <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                                        <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.25rem;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;" id="queueSent">-</div>
                                    </div>
                                    <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                                        <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.25rem;">–û—à–∏–±–∫–∞</div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #ef4444;" id="queueFailed">-</div>
                                    </div>
                                </div>
                                
                                <div id="queueTableContainer" style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid hsl(var(--border)); text-align: left;">
                                                <th style="padding: 0.75rem; font-weight: 600;">ID</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–°—Ç–∞—Ç—É—Å</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–ß–∞—Ç ID</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–ü–æ–ø—ã—Ç–∫–∏</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–°–æ–∑–¥–∞–Ω–æ</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                                                <th style="padding: 0.75rem; font-weight: 600;">–û—à–∏–±–∫–∞</th>
                                            </tr>
                                        </thead>
                                        <tbody id="queueTableBody">
                                            <tr>
                                                <td colspan="8" style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">
                                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="queuePagination" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="users-tab" class="tab-pane">
                        <div class="content">
                            <div class="card" id="createUserCard" style="display: none;">
                                <div class="card-header">
                                    <h2>üë§ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                                </div>
                                <div class="card-content">
                                    <div id="createUserAlert" class="alert"></div>
                                    <form id="createUserForm">
                                        <div class="form-group">
                                            <label for="newUsername">–õ–æ–≥–∏–Ω</label>
                                            <input type="text" id="newUsername" placeholder="username" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="newPassword">–ü–∞—Ä–æ–ª—å</label>
                                            <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                        </div>
                                        <div class="button-group">
                                            <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                                            <button type="button" class="btn-secondary" onclick="cancelCreateUser()">–û—Ç–º–µ–Ω–∞</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="rules-toolbar">
                                    <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                                    <button class="btn-primary btn-small" id="createUserBtn" onclick="showCreateUserForm()" style="display: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    </button>
                                </div>
                                
                                <div id="usersAlert" class="alert"></div>

                                <div id="usersList" class="rules-list">
                                    <p style="color: #999; text-align: center; padding: 40px 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ -->
    <div id="instructionsModal" class="modal" style="display: none;" onclick="closeInstructionsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation();" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h2>
                <button onclick="closeInstructionsModal()" style="margin-left: auto; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: hsl(var(--muted-foreground));">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 2rem; line-height:1.4;">    
                    <h3>üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h3>
                    <ol>
                        <li>–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç <code>@BotFather</code> –≤ Telegram.</li>
                        <li>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∞–≤–∏–ª–æ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–µ—Ä–µ–∑ ¬´–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω¬ª.</li>
                        <li>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ: –∑–∞–¥–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —É—Å–ª–æ–≤–∏–µ (–≤–∏–∑—É–∞–ª—å–Ω–æ –∏–ª–∏ –≤ –∫–æ–¥–µ), —É–∫–∞–∂–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ <code>chatId</code>, —Ç–æ–∫–µ–Ω –∏ —à–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).</li>
                        <li>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–µ–±—Ö—É–∫–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–∏–∂–µ URL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä curl.</li>
                    </ol>

                    <h3 style="margin-top: 1rem;">üìù –ü—Ä–∏–º–µ—Ä—ã —É—Å–ª–æ–≤–∏–π (–∫—Ä–∞—Ç–∫–æ)</h3>
                    <ul>
                        <li><code>payload.team_id === 40</code> ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É ID.</li>
                        <li><code>payload.team.name === "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"</code> ‚Äî –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é.</li>
                        <li><code>payload.status === "error"</code> ‚Äî —Å—Ç–∞—Ç—É—Å.</li>
                        <li><code>payload.note && payload.note.some(n => n.text.includes("—Å—Ä–æ—á–Ω–æ"))</code> ‚Äî –ø–æ–∏—Å–∫ –≤ –º–∞—Å—Å–∏–≤–∞—Ö.</li>
                        <li><code>new Date(payload.created_at) > Date.now() - 3600000</code> ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å).</li>    
                        <li><em>–°–ª–æ–∂–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è</em>: –æ–±—ä–µ–¥–∏–Ω—è–π—Ç–µ —á–µ—Ä–µ–∑ <code>&&</code> / <code>||</code>, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥—ã –º–∞—Å—Å–∏–≤–∞, —Ä–µ–≥—É–ª—è—Ä–∫–∏ –∏ —Ç.–¥.</li>
                    </ul>

                    <h3 style="margin-top: 1rem;">üîó Webhook URL</h3>  
                    <p>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å (–ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ):</p>
                    <div class="webhook-url" id="webhookUrlModal" style="background: hsl(var(--card)); padding: 0.75rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); font-family: monospace; word-break: break-all;"></div>
                    <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
                        <button class="btn-secondary btn-small" onclick="copyWebhookUrlFromModal()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL</button>
                        <small style="color: hsl(var(--muted-foreground));">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π event <code>webhook.verify</code> –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.</small>
                    </div>

                    <h3 style="margin-top: 1rem;">üìã –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞</h3>
                    <pre id="webhookExample" style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); overflow-x: auto; font-size: 0.875rem;"></pre>

                    <h3 style="margin-top: 1rem;">üõ† –û—Ç–ª–∞–¥–∫–∞ –∏ —Å–æ–≤–µ—Ç—ã</h3>
                    <ul>
                        <li>–ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–µ—Ä (–≤–∫–ª–∞–¥–∫–∞ ¬´–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª).</li>
                        <li>–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ—Ö–æ–¥—è—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ ¬´–ò—Å—Ç–æ—Ä–∏—è¬ª –∏ —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏ –≤ ¬´–û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π¬ª.</li>
                        <li>–î–ª—è –º–∞—Å—Å–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PostgreSQL (—É–∫–∞–∂–∏—Ç–µ <code>DATABASE_URL</code>), —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏.</li>
                    </ul>

                    <h3 style="margin-top: 1rem;">‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3> 
                    <ul>
                        <li>–£—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ <code>new Function('payload', ...)</code> ‚Äî –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–¥ –∏–∑ –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.</li>
                        <li>–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞—â–∏—â—ë–Ω–Ω—É—é –ë–î.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="exportImportModal" class="modal" style="display: none;" onclick="closeExportImportModal(event)">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üì§ –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª</h2>
                <button class="icon-btn" onclick="closeExportImportModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 2rem;">
                    <h3>–≠–∫—Å–ø–æ—Ä—Ç</h3>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="selectAllExportRules" style="margin-right: 0.5rem;"> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞
                        </label>
                    </div>
                    <div id="exportRulesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å—é–¥–∞ -->
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-secondary" onclick="exportSelectedRules(); closeExportImportModal();">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                        <button class="btn-secondary" onclick="exportAllRules(); closeExportImportModal();">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
                    </div>
                </div>
                <div>
                    <h3>–ò–º–ø–æ—Ä—Ç</h3>
                    <p>–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ JSON —Ñ–∞–π–ª–∞. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.</p>
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click(); closeExportImportModal();">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importTokenModal" class="modal" style="display: none;" onclick="event.stopPropagation();">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2>üîë –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞</h2>
                <button class="icon-btn" onclick="hideImportTokenModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="importTokenAlert" class="alert"></div>
                <div class="form-group">
                    <label for="importTokenInput">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞)</label>
                    <input type="password" id="importTokenInput" placeholder="123456789:ABCdefGHI...">
                </div>
                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
                    <button class="btn-secondary" onclick="cancelImportToken()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn-primary" onclick="confirmImportToken()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let editingRuleId = null;
        let isEditingRuleLoading = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let authToken = localStorage.getItem('authToken');
        let currentPage = 1;
        const logsPerPage = 10;
        let _pendingImportRules = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // –£–±–∏—Ä–∞–µ–º query string –∏–∑ URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (window.location.search) {
                window.history.replaceState(null, null, window.location.pathname);
            }
            checkAuthStatus();
            setupEventListeners();
            loadSavedTheme();
            updateWebhookUrl();
        });

        function setupEventListeners() {
            // Forms and buttons
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            const ruleForm = document.getElementById('ruleForm');
            if (ruleForm) ruleForm.addEventListener('submit', saveRule);
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    if (tab.dataset.tab === 'users') {
                        loadUsers();
                    } else if (tab.dataset.tab === 'history') {
                        loadWebhookLogs();
                    } else if (tab.dataset.tab === 'queue') {
                        loadQueueHistory();
                        loadQueueStats();
                    }
                });
            });
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
            
            // Condition builder
            document.querySelectorAll('input[name="conditionMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('visualConditionEditor').style.display = this.value === 'visual' ? 'block' : 'none';
                    document.getElementById('codeConditionEditor').style.display = this.value === 'code' ? 'block' : 'none';
                    
                    if (this.value === 'visual') {
                        // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        updateConditionPreview();
                    } else if (this.value === 'code') {
                        // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤ –∫–æ–¥–æ–≤—ã–π —Ä–µ–∂–∏–º –∑–∞–ø–æ–ª–Ω—è–µ–º textarea —Ç–µ–∫—É—â–∏–º —É—Å–ª–æ–≤–∏–µ–º
                        const currentCondition = document.getElementById('condition').value;
                        document.getElementById('conditionCode').value = currentCondition;
                    }
                });
            });
            
            // Visual condition editor
            const fieldSelect = document.querySelector('.field-select');
            if (fieldSelect) fieldSelect.addEventListener('change', updateConditionPreview);
            const operatorSelect = document.querySelector('.operator-select');
            if (operatorSelect) operatorSelect.addEventListener('change', updateConditionPreview);
            const valueInput = document.querySelector('.value-input');
            if (valueInput) valueInput.addEventListener('input', updateConditionPreview);
            const addConditionBtn = document.querySelector('.add-condition-btn');
            if (addConditionBtn) addConditionBtn.addEventListener('click', addConditionRow);
            
            // Group logic radio buttons
            document.querySelectorAll('input[name="groupLogic"]').forEach(radio => {
                radio.addEventListener('change', updateConditionPreview);
            });
            
            // Code condition editor
            const conditionCode = document.getElementById('conditionCode');
            if (conditionCode) conditionCode.addEventListener('input', updateCodeCondition);
            
            // Password toggle
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.addEventListener('click', function() {
                    togglePasswordVisibility('#botToken', this);
                });
            });
            document.querySelectorAll('.toggle-password-test').forEach(btn => {
                btn.addEventListener('click', function() {
                    togglePasswordVisibility('#testBotToken', this);
                });
            });
            
            // Rules search
            const rulesSearch = document.getElementById('rulesSearch');
            if (rulesSearch) rulesSearch.addEventListener('input', function() {
                filterRules(this.value);
            });
            
            // Queue status filter
            const queueStatusFilter = document.getElementById('queueStatusFilter');
            if (queueStatusFilter) {
                queueStatusFilter.addEventListener('change', function() {
                    loadQueueHistory(1);
                });
            }
            
            // Copy webhook URL
            const webhookUrl = document.getElementById('webhookUrl');
            if (webhookUrl) webhookUrl.addEventListener('click', copyWebhookUrl);
            
            // Import file
            const importFileEl = document.getElementById('importFile');
            if (importFileEl) {
                importFileEl.addEventListener('change', importRules);
            }
        }


        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        function togglePasswordVisibility(inputSelector, button) {
            const input = document.querySelector(inputSelector);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function addConditionRow() {
            const newRow = document.createElement('div');
            newRow.className = 'condition-row';
            newRow.innerHTML = `
                <select class="field-select">
                    <option value="payload.team_id">ID –∫–æ–º–∞–Ω–¥—ã</option>
                    <option value="payload.team.name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</option>
                    <option value="payload.status">–°—Ç–∞—Ç—É—Å</option>
                    <option value="payload.category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                    <option value="payload.impact">–í–ª–∏—è–Ω–∏–µ</option>
                    <option value="payload.priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="payload.requested_by.name">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</option>
                </select>
                <select class="operator-select">
                    <option value="===">—Ä–∞–≤–Ω–æ</option>
                    <option value="!==">–Ω–µ —Ä–∞–≤–Ω–æ</option>
                    <option value=">">–±–æ–ª—å—à–µ</option>
                    <option value="<">–º–µ–Ω—å—à–µ</option>
                    <option value="includes">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                </select>
                <input type="text" class="value-input" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                <button type="button" class="remove-condition-btn">-</button>
            `;
            
            document.querySelector('.condition-rows').appendChild(newRow);
            
            // Add event listeners to new elements
            newRow.querySelector('.field-select').addEventListener('change', updateConditionPreview);
            newRow.querySelector('.operator-select').addEventListener('change', updateConditionPreview);
            newRow.querySelector('.value-input').addEventListener('input', updateConditionPreview);
            newRow.querySelector('.remove-condition-btn').addEventListener('click', function() {
                newRow.remove();
                updateConditionPreview();
            });
            
            updateConditionPreview();
        }

        function updateConditionPreview() {
            const conditionRows = document.querySelectorAll('.condition-row');
            const groupLogic = document.querySelector('input[name="groupLogic"]:checked').value;
            
            if (conditionRows.length === 0) {
                document.getElementById('conditionPreview').textContent = '';
                document.getElementById('condition').value = '';
                document.getElementById('testCondition').value = '';
                updateMessagePreview('');
                return;
            }
            
            const conditions = [];
            
            conditionRows.forEach(row => {
                const field = row.querySelector('.field-select').value;
                const operator = row.querySelector('.operator-select').value;
                const value = row.querySelector('.value-input').value;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–∞–≤—ã—á–∫–∏
                let needsQuotes = true;
                let formattedValue = value;
                
                // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π –∏ ID –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
                if (field.includes('.id') || field.includes('_id') || 
                    field.includes('.priority') || 
                    (field === 'payload.priority' && !isNaN(value)) ||
                    (field === 'payload.team_id' && !isNaN(value))) {
                    needsQuotes = false;
                }
                
                // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
                if (operator === '>' || operator === '<' || operator === '>=' || operator === '<=') {
                    needsQuotes = false;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                if (needsQuotes) {
                    // –î–ª—è boolean –∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
                    if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                        formattedValue = value.toLowerCase();
                    } else {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –î–í–û–ô–ù–´–ï –∫–∞–≤—ã—á–∫–∏ –∫–∞–∫ –≤ JSON
                        formattedValue = `"${value.replace(/"/g, '\\"')}"`;
                    }
                } else {
                    // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    formattedValue = value.replace(/['"]/g, '');
                }
                
                const condition = `${field} ${operator} ${formattedValue}`;
                conditions.push(condition);
            });
            
            // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ —Å –ª–æ–≥–∏–∫–æ–π
            const finalCondition = conditions.length === 1 
                ? conditions[0] 
                : conditions.join(` ${groupLogic === 'AND' ? '&&' : '||'} `);
            
            document.getElementById('conditionPreview').textContent = finalCondition;
            document.getElementById('condition').value = finalCondition;
            document.getElementById('testCondition').value = finalCondition;
            updateMessagePreview(finalCondition);
        }

        function updateCodeCondition() {
            const condition = document.getElementById('conditionCode').value;
            document.getElementById('condition').value = condition;
            document.getElementById('conditionPreview').textContent = condition;
            document.getElementById('testCondition').value = condition;
            updateMessagePreview(condition);
        }

        function updateMessagePreview(condition) {
            // This is a simplified preview - in real app you would evaluate the condition
            const payload = {
                id: 141,
                team_id: 40,
                team: {
                    id: 40,
                    name: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
                },
                category: 'incident',
                impact: 'medium',
                subject: '–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è',
                requested_by: {
                    name: '–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è',
                    account: {
                        name: '–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç'
                    }
                },
                note: [{
                    text: 'avwqrgw',
                    person: {
                        name: '–ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π'
                    },
                    account: {
                        name: '–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç'
                    },
                    created_at: '2026-01-07T16:36:27Z'
                }],
                resolution_target_at: '2024-07-29T19:20:00Z',
                response_target_at: '2024-07-26T21:50:00Z'
            };
            
            let message = '';
            
            // ID
            if (payload.id) {
                message += `üÜî ID: ${payload.id}\n\n`;
            }
            
            // Subject
            if (payload.subject) {
                message += `üìã –¢–µ–º–∞: ${payload.subject}\n\n`;
            }
            
            // Requested by
            if (payload.requested_by?.name) {
                const account = payload.requested_by.account?.name || '';
                message += `üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞: ${payload.requested_by.name}${account ? ' @' + account : ''}\n\n`;
            }
            
            // Team, Category, Impact
            if (payload.team?.name) {
                message += `–ö–æ–º–∞–Ω–¥–∞: ${payload.team.name}\n`;
            }
            if (payload.category) {
                message += `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${payload.category}\n`;
            }
            if (payload.impact) {
                message += `–í–ª–∏—è–Ω–∏–µ: ${payload.impact}\n`;
            }
            message += '\n';
            
            // SLA targets
            if (payload.response_target_at || payload.resolution_target_at) {
                if (payload.response_target_at) {
                    try {
                        const date = new Date(payload.response_target_at);
                        if (!isNaN(date.getTime())) {
                            message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞: ${date.toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}\n`;
                        }
                    } catch (e) {
                        message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞: ${payload.response_target_at}\n`;
                    }
                }
                
                if (payload.resolution_target_at) {
                    try {
                        const date = new Date(payload.resolution_target_at);
                        if (!isNaN(date.getTime())) {
                            message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è: ${date.toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}\n`;
                        }
                    } catch (e) {
                        message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è: ${payload.resolution_target_at}\n`;
                    }
                }
                message += '\n';
            }
            
            // Notes
            if (payload.note) {
                message += `üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\n`;
                const notes = Array.isArray(payload.note) ? payload.note : [payload.note];
                notes.forEach((note, index) => {
                    const author = note.person?.name || note.person_name || 'Unknown';
                    const account = note.account?.name || note.person?.account?.name || '';
                    const text = note.text || '';
                    let timestamp = '';
                    
                    if (note.created_at) {
                        try {
                            const date = new Date(note.created_at);
                            if (!isNaN(date.getTime())) {
                                timestamp = date.toLocaleString('ru-RU', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            } else {
                                timestamp = note.created_at;
                            }
                        } catch (e) {
                            timestamp = note.created_at;
                        }
                    }
                    
                    message += `${index + 1}. ${author}${account ? ' @' + account : ''}${timestamp ? ' (' + timestamp + ')' : ''}: ${text}\n`;
                });
            }
            
            document.getElementById('messagePreview').innerHTML = message.replace(/\n/g, '<br>');
        }

        async function checkAuthStatus() {
            if (!authToken) {
                showLoginScreen();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth-status`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                const data = await response.json();

                if (data.authenticated) {
                    showMainApp();
                } else {
                    // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showLoginScreen();
                }
            } catch (error) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                authToken = null;
                localStorage.removeItem('authToken');
                showLoginScreen();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showMainApp();
                } else {
                    showLoginAlert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                showLoginAlert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
            }
        }

        function showLoginScreen() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainApp').style.display = 'none';
        }

        async function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
            
            // setupEventListeners(); // –£–∂–µ –≤—ã–∑–≤–∞–Ω –≤ DOMContentLoaded
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            try {
                const response = await fetch(`${API_BASE}/me`, { headers: getHeaders() });
                if (response.status === 401) {
                    // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showLoginScreen();
                    return;
                }
                if (response.ok) {
                    const data = await response.json();
                    currentUserData = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    currentUserId = data.userId;
                    const usernameEl = document.getElementById('currentUsername');
                    if (usernameEl) {
                        usernameEl.textContent = `üë§ ${data.username}`;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –¥–ª—è vadmin
                    const usersTab = document.getElementById('usersTab');
                    const createUserBtn = document.getElementById('createUserBtn');
                    if (usersTab && createUserBtn) {
                        if (data.username === 'vadmin') {
                            usersTab.style.display = 'flex';
                            createUserBtn.style.display = 'flex';
                            loadUsers();
                        } else {
                            usersTab.style.display = 'none';
                            createUserBtn.style.display = 'none';
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω –∞–≤—Ç–æ—Ä–æ–≤ (–±–µ–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                            loadUsersForCache();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
            
            loadRules();
            loadWebhookLogs();
        }

        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.className = `login-alert show alert-${type}`;
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/logout`, { 
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                localStorage.removeItem('authToken');
                authToken = null;
                showLoginScreen();
                document.getElementById('loginForm').reset();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function updateWebhookUrl() {
            const url = `${window.location.origin}/webhook`;
            const webhookUrlElement = document.getElementById('webhookUrl');
            const webhookUrlSettingsElement = document.getElementById('webhookUrlSettings');
            const webhookUrlModalElement = document.getElementById('webhookUrlModal');
            const webhookExampleElement = document.getElementById('webhookExample');
            
            if (webhookUrlElement) {
                webhookUrlElement.textContent = url;
            }
            if (webhookUrlSettingsElement) {
                webhookUrlSettingsElement.textContent = url;
            }
            if (webhookUrlModalElement) {
                webhookUrlModalElement.textContent = url;
            }
            if (webhookExampleElement) {
                webhookExampleElement.textContent = `curl -X POST ${url} \\
  -H "Content-Type: application/json" \\
  -d '{
    "team_id": 40,
    "team": {
      "id": 40,
      "name": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    },
    "category": "incident",
    "impact": "medium",
    "subject": "–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è",
    "requested_by": {
      "name": "–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è",
      "account": {
        "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
      }
    }
  }'`;
            }
        }

        async function loadRules() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞
            const detailsPanel = document.getElementById('ruleDetails');
            const placeholder = document.getElementById('ruleDetailsPlaceholder');
            const detailsView = document.getElementById('ruleDetailsView');
            const formContainer = document.getElementById('ruleFormContainer');
            
            if (detailsPanel && placeholder) {
                detailsPanel.style.display = 'none';
                placeholder.style.display = 'block';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä, –∏ —Ñ–æ—Ä–º—É
            if (detailsView) {
                detailsView.style.display = 'none';
            }
            if (formContainer) {
                formContainer.style.display = 'none';
            }
            
            try {
                const response = await fetch(`${API_BASE}/rules`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const rules = await response.json();
                
                if (!Array.isArray(rules)) {
                    console.error('Invalid response format:', rules);
                    throw new Error('Invalid response format from server');
                }
                
                displayRules(rules);
            } catch (error) {
                console.error('Error loading rules:', error);
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª: ' + error.message, 'error');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–∞–≤–∏–ª
                const container = document.getElementById('rulesList');
                if (container) {
                    container.innerHTML = '<p style="color: hsl(var(--destructive)); text-align: center; padding: 40px 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª: ' + escapeHtml(error.message) + '</p>';
                }
            }
        }

        function renderRuleCard(rule) {
            return `
                <div class="rule-item ${rule.enabled ? '' : 'disabled'}" data-id="${rule.id}">
                    <div class="rule-content">
                        <div class="rule-name">
                            ${rule.enabled ? '‚úÖ' : '‚è∏Ô∏è'} 
                            ${escapeHtml(rule.name)}
                        </div>
                        <div class="rule-condition">${escapeHtml(rule.condition)}</div>
                        <div class="rule-channel">üìç –ö–∞–Ω–∞–ª: <code>${escapeHtml(rule.chatId)}</code></div>
                        ${rule.botToken && typeof rule.botToken === 'string' ? `<div class="rule-bot">ü§ñ –ë–æ—Ç: <code>${escapeHtml(rule.botToken.substring(0, 10))}...</code></div>` : ''}
                        <div class="rule-status">
                            <span class="status-badge ${rule.enabled ? '' : 'disabled'}"></span>
                            ${rule.enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ'}
                        </div>
                    </div>
                    <div class="rule-actions">
                        <button class="btn-secondary btn-small" onclick="event.stopPropagation(); duplicateRule(${rule.id})">üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-primary btn-small" onclick="event.stopPropagation(); editRule(${rule.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteRule(${rule.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
        }

        function sortRules(field) {
            if (window.rulesSortField === field) {
                window.rulesSortDirection = window.rulesSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                window.rulesSortField = field;
                window.rulesSortDirection = 'asc';
            }
            loadRules(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ —Å –Ω–æ–≤–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
        }

        function displayRules(rules) {
            const container = document.getElementById('rulesList');
            const searchQuery = document.getElementById('rulesSearch').value.toLowerCase();
            
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏)
            if (typeof window.rulesSortField === 'undefined') {
                window.rulesSortField = 'name';
                window.rulesSortDirection = 'asc';
            }
            
            const filteredRules = rules.filter(rule => 
                rule.name.toLowerCase().includes(searchQuery) ||
                rule.condition.toLowerCase().includes(searchQuery) ||
                rule.chatId.toString().includes(searchQuery)
            ).sort((a, b) => {
                let aVal = a[window.rulesSortField];
                let bVal = b[window.rulesSortField];
                
                if (window.rulesSortField === 'enabled') {
                    aVal = aVal ? 1 : 0;
                    bVal = bVal ? 1 : 0;
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                if (window.rulesSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            if (filteredRules.length === 0) {
                container.innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center; padding: 40px 20px;">–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid hsl(var(--border)); text-align: left;">
                            <th style="padding: 0.5rem; font-weight: 600; cursor: pointer;" onclick="sortRules('enabled')">–°—Ç–∞—Ç—É—Å ${window.rulesSortField === 'enabled' ? (window.rulesSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                            <th style="padding: 0.5rem; font-weight: 600; cursor: pointer;" onclick="sortRules('name')">–ù–∞–∑–≤–∞–Ω–∏–µ ${window.rulesSortField === 'name' ? (window.rulesSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                            <th style="padding: 0.5rem; font-weight: 600; cursor: pointer;" onclick="sortRules('condition')">–£—Å–ª–æ–≤–∏–µ ${window.rulesSortField === 'condition' ? (window.rulesSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                            <th style="padding: 0.5rem; font-weight: 600; cursor: pointer;" onclick="sortRules('chatId')">–ö–∞–Ω–∞–ª ${window.rulesSortField === 'chatId' ? (window.rulesSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredRules.map(rule => {
                            const canEdit = currentUserData && (
                                currentUserData.username === 'vadmin' || 
                                (rule.authorId && typeof rule.authorId === 'number' && rule.authorId === currentUserData.userId) ||
                                (rule.authorId === 'vadmin' && currentUserData.username === 'vadmin')
                            );
                            return `
                            <tr class="rule-row" data-rule-id="${rule.id}" style="border-bottom: 1px solid hsl(var(--border)); cursor: pointer; transition: background 0.2s;" 
                                onmouseover="this.style.background='hsl(var(--accent))'" 
                                onmouseout="this.style.background='transparent'"
                                onclick="loadRuleDetails(${rule.id})">
                                <td style="padding: 0.75rem 0.5rem;">
                                    <span class="${rule.enabled ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                        ${rule.enabled ? '‚úÖ –í–∫–ª' : '‚è∏Ô∏è –í—ã–∫–ª'}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem 0.5rem; font-weight: 500;">${escapeHtml(rule.name)}</td>
                                <td style="padding: 0.75rem 0.5rem;"><code style="font-size: 0.875rem; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(rule.condition)}</code></td>
                                <td style="padding: 0.75rem 0.5rem;"><code>${escapeHtml(rule.chatId)}</code></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateRuleCard(updatedRule) {
            const container = document.getElementById('rulesList');
            const ruleRow = container.querySelector(`tr[data-rule-id="${updatedRule.id}"]`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
            const searchQuery = document.getElementById('rulesSearch').value.toLowerCase();
            const matchesFilter = 
                updatedRule.name.toLowerCase().includes(searchQuery) ||
                updatedRule.condition.toLowerCase().includes(searchQuery) ||
                updatedRule.chatId.toString().includes(searchQuery);
            
            if (!ruleRow) {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
                loadRules();
                return;
            }
            
            if (matchesFilter) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
                ruleRow.outerHTML = `
                    <tr class="rule-row" data-rule-id="${updatedRule.id}" style="border-bottom: 1px solid hsl(var(--border)); cursor: pointer; transition: background 0.2s;" 
                        onmouseover="this.style.background='hsl(var(--accent))'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="loadRuleDetails(${updatedRule.id})">
                        <td style="padding: 0.75rem 0.5rem;">
                            <span class="${updatedRule.enabled ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                ${updatedRule.enabled ? '‚úÖ –í–∫–ª' : '‚è∏Ô∏è –í—ã–∫–ª'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">${escapeHtml(updatedRule.name)}</td>
                        <td style="padding: 0.75rem 0.5rem;"><code style="font-size: 0.875rem; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(updatedRule.condition)}</code></td>
                        <td style="padding: 0.75rem 0.5rem;"><code>${escapeHtml(updatedRule.chatId)}</code></td>
                    </tr>
                `;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç–æ –≤ –¥–µ—Ç–∞–ª—è—Ö, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ç–æ–∂–µ
                const detailsPanel = document.getElementById('ruleDetails');
                const detailsView = document.getElementById('ruleDetailsView');
                if (detailsPanel && detailsPanel.style.display !== 'none' && 
                    detailsView && detailsView.style.display !== 'none') {
                    loadRuleDetails(updatedRule.id);
                }
            } else {
                // –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                ruleRow.remove();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â–µ –ø—Ä–∞–≤–∏–ª–∞
                const tbody = container.querySelector('tbody');
                if (tbody && tbody.children.length === 0) {
                    container.innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center; padding: 40px 20px;">–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            }
        }

        async function loadRuleDetails(ruleId) {
            const detailsPanel = document.getElementById('ruleDetails');
            const placeholder = document.getElementById('ruleDetailsPlaceholder');
            const detailsView = document.getElementById('ruleDetailsView');
            const formContainer = document.getElementById('ruleFormContainer');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
            if (detailsPanel && placeholder) {
                detailsPanel.style.display = 'block';
                placeholder.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            if (detailsView) {
                detailsView.style.display = 'block';
            }
            if (formContainer) {
                formContainer.style.display = 'none';
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ –∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            document.querySelectorAll('.rule-row').forEach(row => {
                row.style.background = 'transparent';
                if (parseInt(row.dataset.ruleId) === ruleId) {
                    row.style.background = 'hsl(var(--accent))';
                }
            });
            
            const detailsContainer = document.getElementById('ruleDetailsContent');
            if (!detailsContainer) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            detailsContainer.innerHTML = '<div class="loading"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...';
            
            try {
                const response = await fetch(`${API_BASE}/rules/${ruleId}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª–∞');
                }
                
                const rule = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                const canEdit = currentUserData && (
                    currentUserData.username === 'vadmin' || 
                    (rule.authorId && typeof rule.authorId === 'number' && rule.authorId === currentUserData.userId) ||
                    (rule.authorId === 'vadmin' && currentUserData.username === 'vadmin')
                );
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∞–≤—Ç–æ—Ä–∞
                const authorName = getAuthorName(rule.authorId);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏
                detailsContainer.innerHTML = `
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        ${canEdit ? `<button class="btn-secondary btn-small" onclick="event.stopPropagation(); duplicateRule(${rule.id})">üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                        ${canEdit ? `<button class="btn-primary btn-small" onclick="event.stopPropagation(); editRule(${rule.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                        <button class="btn-primary btn-small" onclick="event.stopPropagation(); createNewRule()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ
                        </button>
                        ${canEdit ? `<button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteRule(${rule.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∞–≤–∏–ª–µ</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); position: relative;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong>ID:</strong> <code>${rule.id}</code>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(rule.name || '')}
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>–ê–≤—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª–∞:</strong> ${escapeHtml(authorName)}${rule.authorId === 'vadmin' ? ' <span style="color: #667eea;">(vadmin)</span>' : ''}
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                <span class="${rule.enabled !== false ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px;">
                                    ${rule.enabled !== false ? '‚úÖ –í–∫–ª—é—á–µ–Ω–æ' : '‚è∏Ô∏è –û—Ç–∫–ª—é—á–µ–Ω–æ'}
                                </span>
                            </div>
                            <div style="position: absolute; bottom: 1rem; right: 1rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong><br>
                                ${rule.updated_at ? new Date(rule.updated_at).toLocaleString('ru-RU') : (rule.created_at ? new Date(rule.created_at).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">–£—Å–ª–æ–≤–∏–µ</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); overflow-x: auto;">
                            <code style="font-size: 0.875rem; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(rule.condition || '')}</code>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                            <div style="margin-bottom: 0.75rem;">
                                <strong>ID –∫–∞–Ω–∞–ª–∞/—á–∞—Ç–∞:</strong> <code>${escapeHtml(rule.chatId || '')}</code>
                            </div>
                            ${rule.botToken && typeof rule.botToken === 'string' ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <strong>–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</strong> <code>${escapeHtml(rule.botToken.substring(0, 10))}...</code>
                                </div>
                            ` : ''}
                            ${rule.messageTemplate ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <strong>–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è:</strong>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: hsl(var(--muted) / 0.3); border-radius: 4px; white-space: pre-wrap; font-size: 0.875rem;">${escapeHtml(rule.messageTemplate)}</div>
                                </div>
                            ` : '<div style="margin-bottom: 0.75rem; color: hsl(var(--muted-foreground));">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>'}
                        </div>
                    </div>
                `;
            } catch (error) {
                detailsContainer.innerHTML = `
                    <div style="color: hsl(var(--destructive)); padding: 1rem; background: hsl(var(--destructive) / 0.1); border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--destructive) / 0.3);">
                        <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function createNewRule() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            editingRuleId = null;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å —Ñ–æ—Ä–º–æ–π –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
            const detailsPanel = document.getElementById('ruleDetails');
            const placeholder = document.getElementById('ruleDetailsPlaceholder');
            const detailsView = document.getElementById('ruleDetailsView');
            const formContainer = document.getElementById('ruleFormContainer');
            
            if (detailsPanel && placeholder) {
                detailsPanel.style.display = 'block';
                placeholder.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä
            if (detailsView) {
                detailsView.style.display = 'none';
            }
            if (formContainer) {
                formContainer.style.display = 'block';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('ruleForm').reset();
            document.getElementById('addAlert').innerHTML = '';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —É—Å–ª–æ–≤–∏–π
            document.querySelector('input[name="conditionMode"][value="visual"]').checked = true;
            document.getElementById('visualConditionEditor').style.display = 'block';
            document.getElementById('codeConditionEditor').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ
            const conditionRows = document.querySelectorAll('.condition-row');
            for (let i = 1; i < conditionRows.length; i++) {
                conditionRows[i].remove();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —É—Å–ª–æ–≤–∏–µ
            document.querySelector('.field-select').value = 'payload.category';
            document.querySelector('.operator-select').value = '===';
            document.querySelector('.value-input').value = 'incident';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É –Ω–∞ AND
            document.querySelector('input[name="groupLogic"][value="AND"]').checked = true;
            
            document.getElementById('condition').value = 'payload.category === "incident"';
            document.getElementById('conditionCode').value = '';
            updateConditionPreview();
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
            document.querySelectorAll('.rule-row').forEach(row => {
                row.style.background = 'transparent';
            });
        }

        function filterRules(query) {
            loadRules();
        }

        async function saveRule(e) {
            e.preventDefault();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!authToken) {
                showAlert('addAlert', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                showLoginScreen();
                return;
            }

            const ruleName = document.getElementById('ruleName').value.trim();
            const condition = document.getElementById('condition').value.trim();
            const chatId = document.getElementById('chatId').value.trim();
            const botToken = document.getElementById('botToken').value.trim();
            const messageTemplate = document.getElementById('messageTemplate').value.trim();
            const enabled = document.getElementById('enabled').checked;

            // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∏–ª–∏ –≤—Å–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
            if (!editingRuleId) {
                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –≤—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
                if (!ruleName || !condition || !chatId || !botToken) {
                    showAlert('addAlert', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∑–≤–∞–Ω–∏–µ, –£—Å–ª–æ–≤–∏–µ, ID –∫–∞–Ω–∞–ª–∞, –¢–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                    return;
                }
            } else {
                // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –ø—É—Å—Ç—ã–µ
                if (!ruleName || !condition || !chatId || !botToken) {
                    showAlert('addAlert', '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏: –ù–∞–∑–≤–∞–Ω–∏–µ, –£—Å–ª–æ–≤–∏–µ, ID –∫–∞–Ω–∞–ª–∞, –¢–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                    return;
                }
            }

            try {
                const method = editingRuleId ? 'PUT' : 'POST';
                const url = editingRuleId 
                    ? `${API_BASE}/rules/${editingRuleId}`
                    : `${API_BASE}/rules`;

                const response = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify({
                        name: ruleName,
                        condition: condition,
                        chatId: chatId,
                        botToken: botToken,
                        messageTemplate: messageTemplate || null,
                        enabled: enabled
                    })
                });

                if (response.status === 401) {
                    showAlert('addAlert', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showLoginScreen();
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || 'Failed to save rule');
                }

                const savedRule = await response.json();

                showAlert('addAlert', editingRuleId ? '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
                
                const wasEditing = editingRuleId;
                const savedRuleId = savedRule.id;
                
                if (wasEditing) {
                    // –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
                    updateRuleCard(savedRule);
                } else {
                    // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
                    await loadRules();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
                await loadRuleDetails(savedRuleId);
            } catch (error) {
                showAlert('addAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function editRule(id) {
            // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —ç—Ç–æ –≤–∞–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –î–û –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            editingRuleId = id;
            isEditingRuleLoading = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å —Ñ–æ—Ä–º–æ–π –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
            const detailsPanel = document.getElementById('ruleDetails');
            const placeholder = document.getElementById('ruleDetailsPlaceholder');
            const detailsView = document.getElementById('ruleDetailsView');
            const formContainer = document.getElementById('ruleFormContainer');
            
            if (detailsPanel && placeholder) {
                detailsPanel.style.display = 'block';
                placeholder.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä
            if (detailsView) {
                detailsView.style.display = 'none';
            }
            if (formContainer) {
                formContainer.style.display = 'block';
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ –∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            document.querySelectorAll('.rule-row').forEach(row => {
                row.style.background = 'transparent';
                if (parseInt(row.dataset.ruleId) === id) {
                    row.style.background = 'hsl(var(--accent))';
                }
            });
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–æ ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const response = await fetch(`${API_BASE}/rules/${id}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showAlert('addAlert', '–ü—Ä–∞–≤–∏–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                        editingRuleId = null;
                    } else {
                        throw new Error('Failed to load rule');
                    }
                    return;
                }
                
                const rule = await response.json();

                if (!rule) {
                    isEditingRuleLoading = false;
                    return;
                }

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
                document.getElementById('ruleName').value = rule.name || '';
                document.getElementById('chatId').value = rule.chatId || '';
                document.getElementById('botToken').value = rule.botToken || '';
                document.getElementById('messageTemplate').value = rule.messageTemplate || '';
                document.getElementById('enabled').checked = rule.enabled !== false;
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–µ condition –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
                if (rule.condition) {
                    document.getElementById('condition').value = rule.condition;
                }

                // Handle condition mode
                const visualMode = document.querySelector('input[name="conditionMode"][value="visual"]');
                const codeMode = document.querySelector('input[name="conditionMode"][value="code"]');
                
                // Try to parse condition for visual mode
                if (rule.condition && (rule.condition.includes('team_id') || rule.condition.includes('team.name') || 
                    rule.condition.includes('category') || rule.condition.includes('impact') ||
                    rule.condition.includes('&&') || rule.condition.includes('||'))) {
                    visualMode.checked = true;
                    document.getElementById('visualConditionEditor').style.display = 'block';
                    document.getElementById('codeConditionEditor').style.display = 'none';
                    
                    try {
                        parseConditionToVisual(rule.condition);
                        updateConditionPreview();
                    } catch (e) {
                        // Fallback to code mode
                        codeMode.checked = true;
                        document.getElementById('visualConditionEditor').style.display = 'none';
                        document.getElementById('codeConditionEditor').style.display = 'block';
                        document.getElementById('conditionCode').value = rule.condition;
                    }
                } else {
                    codeMode.checked = true;
                    document.getElementById('visualConditionEditor').style.display = 'none';
                    document.getElementById('codeConditionEditor').style.display = 'block';
                    document.getElementById('conditionCode').value = rule.condition || '';
                }
                
                // –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º condition –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                if (rule.condition) {
                    document.getElementById('condition').value = rule.condition;
                }
                
                // editingRuleId –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
                isEditingRuleLoading = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('ruleForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                editingRuleId = null;
                isEditingRuleLoading = false;
                showAlert('addAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª–∞: ' + error.message, 'error');
            }
        }

        async function deleteRule(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ?')) return;

            try {
                const response = await fetch(`${API_BASE}/rules/${id}`, { 
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (!response.ok) throw new Error('Failed to delete rule');

                showAlert('rulesAlert', '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                
                // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                if (editingRuleId === id) {
                    editingRuleId = null;
                    const detailsPanel = document.getElementById('ruleDetails');
                    const placeholder = document.getElementById('ruleDetailsPlaceholder');
                    if (detailsPanel && placeholder) {
                        detailsPanel.style.display = 'none';
                        placeholder.style.display = 'block';
                    }
                }
                
                await loadRules();
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message, 'error');
            }
        }

        async function duplicateRule(id) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
                const response = await fetch(`${API_BASE}/rules/${id}`, {
                    headers: getHeaders()
                });
                
                if (response.status === 401) {
                    showAlert('rulesAlert', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showLoginScreen();
                    return;
                }
                
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
                
                const originalRule = await response.json();
                
                // –°–æ–∑–¥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
                const duplicateData = {
                    name: `${originalRule.name} (–∫–æ–ø–∏—è)`,
                    condition: originalRule.condition,
                    chatId: originalRule.chatId,
                    botToken: originalRule.botToken,
                    messageTemplate: originalRule.messageTemplate || null,
                    enabled: false // –û—Ç–∫–ª—é—á–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                };
                
                const createResponse = await fetch(`${API_BASE}/rules`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(duplicateData)
                });
                
                if (createResponse.status === 401) {
                    showAlert('rulesAlert', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showLoginScreen();
                    return;
                }
                
                if (!createResponse.ok) {
                    const errorData = await createResponse.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || 'Failed to create duplicate rule');
                }
                
                showAlert('rulesAlert', '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                await loadRules();
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message, 'error');
            }
        }

        async function testCondition() {
            const condition = document.getElementById('testCondition').value;
            const payloadStr = document.getElementById('testPayload').value;

            if (!condition || !payloadStr) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ –∏ payload');
                return;
            }

            try {
                const payload = JSON.parse(payloadStr);
                const resultDiv = document.getElementById('testResult');
                resultDiv.innerHTML = `<div class="loading"></div> –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ...`;
                resultDiv.style.display = 'block';
                resultDiv.className = 'test-result';

                // Evaluate condition locally for testing
                try {
                    const fn = new Function('payload', `return ${condition}`);
                    const result = fn(payload);
                    
                    resultDiv.innerHTML = `<strong>‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <strong>${result ? 'TRUE' : 'FALSE'}</strong><br><small>–£—Å–ª–æ–≤–∏–µ: ${escapeHtml(condition)}</small>`;
                    resultDiv.className = `test-result ${result ? 'success' : 'error'}`;
                } catch (evalError) {
                    resultDiv.innerHTML = `<strong>‚úó –û—à–∏–±–∫–∞ –≤ —É—Å–ª–æ–≤–∏–∏:</strong> ${escapeHtml(evalError.message)}`;
                    resultDiv.className = 'test-result error';
                }
            } catch (error) {
                const resultDiv = document.getElementById('testResult');
                resultDiv.innerHTML = `<strong>‚úó –û—à–∏–±–∫–∞:</strong> –ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ payload: ${error.message}`;
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
            }
        }

        async function testTelegramSend() {
            const chatId = document.getElementById('testChatId').value;
            const message = document.getElementById('testMessage').value;
            const botToken = document.getElementById('testBotToken').value.trim();
            
            if (!chatId || !message) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID —á–∞—Ç–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            const resultDiv = document.getElementById('telegramTestResult');
            resultDiv.innerHTML = '<div class="loading"></div> –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            
            try {
                const response = await fetch('/api/test-send', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ chatId, message, botToken: botToken || undefined })
                });
                
                const result = await response.json();
                if (result.success) {
                    let message = `‚úÖ <strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</strong> –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ${chatId}.<br><small>Telegram Message ID: ${result.response?.result?.message_id || 'N/A'}</small>`;
                    if (botToken) {
                        message += '<br><small style="color: #667eea;">üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–æ–∫–µ–Ω –∏–∑ –ø–æ–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>';
                    }
                    resultDiv.innerHTML = message;
                    resultDiv.className = 'test-result success';
                } else {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º
                    let errorMsg = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    if (result.error) {
                        if (typeof result.error === 'string') {
                            errorMsg = result.error;
                        } else if (result.error.description) {
                            errorMsg = result.error.description;
                        } else if (result.error.error_code) {
                            errorMsg = `–û—à–∏–±–∫–∞ ${result.error.error_code}: ${result.error.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ Telegram API'}`;
                        } else {
                            errorMsg = JSON.stringify(result.error);
                        }
                    }
                    resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong> ${escapeHtml(errorMsg)}`;
                    resultDiv.className = 'test-result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:</strong> ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function loadWebhookLogs(page = 1) {
            currentPage = page;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞
            document.getElementById('logDetails').style.display = 'none';
            document.getElementById('logDetailsPlaceholder').style.display = 'block';
            document.getElementById('logDetailsContent').innerHTML = '';
            
            document.getElementById('logsContainer').innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
            document.getElementById('logsContainer').className = 'logs-container skeleton';
            
            try {
                const response = await fetch(`${API_BASE}/webhook-logs`, {
                    headers: getHeaders()
                });
                const logs = await response.json();
                displayWebhookLogs(logs, page);
            } catch (error) {
                document.getElementById('logsContainer').innerHTML = `<p class="log-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</p>`;
                document.getElementById('logsContainer').className = 'logs-container';
            }
        }

        function displayWebhookLogs(logs, page) {
            const container = document.getElementById('logsContainer');
            container.className = 'logs-container';
            
            const startIndex = (page - 1) * logsPerPage;
            const endIndex = Math.min(startIndex + logsPerPage, logs.length);
            const pageLogs = logs.slice(startIndex, endIndex);
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                updatePagination(1, 1);
                return;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid hsl(var(--border)); text-align: left;">
                            <th style="padding: 0.5rem; font-weight: 600;">–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                            <th style="padding: 0.5rem; font-weight: 600;">ID</th>
                            <th style="padding: 0.5rem; font-weight: 600;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="padding: 0.5rem; font-weight: 600;">–°–æ–≤–ø–∞–¥–µ–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageLogs.map(log => `
                            <tr class="log-row" data-log-id="${log.id}" style="border-bottom: 1px solid hsl(var(--border)); cursor: pointer; transition: background 0.2s;" 
                                onmouseover="this.style.background='hsl(var(--accent))'" 
                                onmouseout="this.style.background='transparent'"
                                onclick="loadLogDetails(${log.id})">
                                <td style="padding: 0.75rem 0.5rem;">${new Date(log.timestamp).toLocaleString('ru-RU')}</td>
                                <td style="padding: 0.75rem 0.5rem;"><code>${log.id}</code></td>
                                <td style="padding: 0.75rem 0.5rem;">
                                    <span class="${log.status === 'matched' ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                        ${log.status === 'matched' ? '‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏—è' : '‚õî –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π'}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem 0.5rem;">${log.matched}/${log.total_rules}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            const totalPages = Math.ceil(logs.length / logsPerPage);
            updatePagination(page, totalPages);
        }

        function updatePagination(currentPage, totalPages) {
            document.querySelector('.page-info').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
            
            document.querySelector('.prev').disabled = currentPage === 1;
            document.querySelector('.next').disabled = currentPage === totalPages;
            
            document.querySelector('.prev').onclick = () => loadWebhookLogs(currentPage - 1);
            document.querySelector('.next').onclick = () => loadWebhookLogs(currentPage + 1);
        }

        async function loadLogDetails(logId) {
            const detailsContainer = document.getElementById('logDetailsContent');
            const detailsPanel = document.getElementById('logDetails');
            const placeholder = document.getElementById('logDetailsPlaceholder');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
            detailsPanel.style.display = 'block';
            placeholder.style.display = 'none';
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫ –∏ –≤—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            document.querySelectorAll('.log-row').forEach(row => {
                row.style.background = 'transparent';
                if (parseInt(row.dataset.logId) === logId) {
                    row.style.background = 'hsl(var(--accent))';
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            detailsContainer.innerHTML = '<div class="loading"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...';
            
            try {
                const response = await fetch(`${API_BASE}/webhook-logs/${logId}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏');
                }
                
                const log = await response.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏
                detailsContainer.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                            <div style="margin-bottom: 0.75rem;"><strong>ID:</strong> <code>${log.id}</code></div>
                            <div style="margin-bottom: 0.75rem;"><strong>–î–∞—Ç–∞/–í—Ä–µ–º—è:</strong> ${new Date(log.timestamp).toLocaleString('ru-RU')}</div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                <span class="${log.status === 'matched' ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px;">
                                    ${log.status === 'matched' ? '‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è' : '‚õî –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π'}
                                </span>
                            </div>
                            <div style="margin-bottom: 0.75rem;"><strong>–°–æ–≤–ø–∞–≤—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞:</strong> ${log.matched} –∏–∑ ${log.total_rules}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">Payload (–î–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞)</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); overflow-x: auto;">
                            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 0.875rem;">${JSON.stringify(log.payload, null, 2)}</pre>
                        </div>
                    </div>
                    
                    ${log.telegram_results && log.telegram_results.length > 0 ? `
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: hsl(var(--muted-foreground));">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram</h4>
                        <div style="background: hsl(var(--card)); padding: 1rem; border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border));">
                            ${log.telegram_results.map((result, idx) => `
                                <div style="margin-bottom: ${idx < log.telegram_results.length - 1 ? '1rem' : '0'}; padding-bottom: ${idx < log.telegram_results.length - 1 ? '1rem' : '0'}; border-bottom: ${idx < log.telegram_results.length - 1 ? '1px solid hsl(var(--border))' : 'none'};">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>Chat ID:</strong> <code>${result.chatId || 'N/A'}</code>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                        <span class="${result.success ? 'log-success' : 'log-error'}" style="padding: 0.25rem 0.5rem; border-radius: 4px;">
                                            ${result.success ? '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'}
                                        </span>
                                    </div>
                                    ${result.success && result.response?.result?.message_id ? `
                                        <div style="margin-bottom: 0.5rem;">
                                            <strong>Message ID:</strong> <code>${result.response.result.message_id}</code>
                                        </div>
                                    ` : ''}
                                    ${result.error ? `
                                        <div>
                                            <strong>–û—à–∏–±–∫–∞:</strong>
                                            <pre style="margin: 0.5rem 0 0 0; padding: 0.5rem; background: hsl(var(--destructive) / 0.1); border-radius: 4px; font-size: 0.875rem; overflow-x: auto;">${JSON.stringify(result.error, null, 2)}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : '<div style="color: hsl(var(--muted-foreground));">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –Ω–µ—Ç</div>'}
                `;
            } catch (error) {
                detailsContainer.innerHTML = `
                    <div style="color: hsl(var(--destructive)); padding: 1rem; background: hsl(var(--destructive) / 0.1); border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--destructive) / 0.3);">
                        <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:</strong> ${error.message}
                    </div>
                `;
            }
        }

        let currentQueuePage = 1;
        let queueStatusFilter = '';

        async function loadQueueHistory(page = 1) {
            currentQueuePage = page;
            const status = document.getElementById('queueStatusFilter')?.value || '';
            queueStatusFilter = status;
            
            const tbody = document.getElementById('queueTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            }
            
            try {
                let url = `${API_BASE}/message-queue/history?page=${page}&limit=50`;
                if (status) {
                    url += `&status=${encodeURIComponent(status)}`;
                }
                
                const response = await fetch(url, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayQueueHistory(data.messages, data.pagination);
                loadQueueStats();
            } catch (error) {
                console.error('Error loading queue history:', error);
                showAlert('queueAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ—á–µ—Ä–µ–¥–∏: ' + error.message, 'error');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: hsl(var(--destructive));">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(error.message)}</td></tr>`;
                }
            }
        }

        function displayQueueHistory(messages, pagination) {
            const tbody = document.getElementById('queueTableBody');
            if (!tbody) return;
            
            if (messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">–ò—Å—Ç–æ—Ä–∏—è –æ—á–µ—Ä–µ–¥–∏ –ø—É—Å—Ç–∞</td></tr>';
                updateQueuePagination(pagination);
                return;
            }
            
            tbody.innerHTML = messages.map(msg => {
                const statusBadge = getStatusBadge(msg.status);
                const createdAt = new Date(msg.createdAt).toLocaleString('ru-RU');
                const sentAt = msg.sentAt ? new Date(msg.sentAt).toLocaleString('ru-RU') : '-';
                const errorMsg = msg.errorMessage ? (typeof msg.errorMessage === 'string' ? msg.errorMessage.substring(0, 100) : JSON.stringify(msg.errorMessage).substring(0, 100)) : '-';
                
                return `
                    <tr style="border-bottom: 1px solid hsl(var(--border));">
                        <td style="padding: 0.75rem;"><code>${msg.id}</code></td>
                        <td style="padding: 0.75rem;">${statusBadge}</td>
                        <td style="padding: 0.75rem;"><code>${escapeHtml(msg.chatId)}</code></td>
                        <td style="padding: 0.75rem; max-width: 300px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(msg.messageTextFull)}">
                                ${escapeHtml(msg.messageText)}
                            </div>
                        </td>
                        <td style="padding: 0.75rem;">
                            <span style="color: ${msg.attempts >= msg.maxAttempts ? 'hsl(var(--destructive))' : 'hsl(var(--muted-foreground))'};">
                                ${msg.attempts}/${msg.maxAttempts}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.875rem;">${createdAt}</td>
                        <td style="padding: 0.75rem; font-size: 0.875rem;">${sentAt}</td>
                        <td style="padding: 0.75rem; font-size: 0.875rem; max-width: 200px;">
                            ${errorMsg !== '-' ? `<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: hsl(var(--destructive));" title="${escapeHtml(errorMsg)}">${escapeHtml(errorMsg)}</div>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateQueuePagination(pagination);
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="padding: 0.25rem 0.5rem; border-radius: 4px; background: #f59e0b; color: white; font-size: 0.875rem;">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>',
                'processing': '<span style="padding: 0.25rem 0.5rem; border-radius: 4px; background: #3b82f6; color: white; font-size: 0.875rem;">üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</span>',
                'sent': '<span style="padding: 0.25rem 0.5rem; border-radius: 4px; background: #10b981; color: white; font-size: 0.875rem;">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>',
                'failed': '<span style="padding: 0.25rem 0.5rem; border-radius: 4px; background: #ef4444; color: white; font-size: 0.875rem;">‚ùå –û—à–∏–±–∫–∞</span>'
            };
            return badges[status] || `<span style="padding: 0.25rem 0.5rem; border-radius: 4px; background: hsl(var(--muted)); font-size: 0.875rem;">${status}</span>`;
        }

        function updateQueuePagination(pagination) {
            const paginationContainer = document.getElementById('queuePagination');
            if (!paginationContainer) return;
            
            if (pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            paginationContainer.innerHTML = `
                <button class="btn-secondary" ${pagination.page === 1 ? 'disabled' : ''} onclick="loadQueueHistory(${pagination.page - 1})">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
                <span style="padding: 0 1rem;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${pagination.totalPages} (–≤—Å–µ–≥–æ: ${pagination.total})</span>
                <button class="btn-secondary" ${pagination.page >= pagination.totalPages ? 'disabled' : ''} onclick="loadQueueHistory(${pagination.page + 1})">
                    –í–ø–µ—Ä–µ–¥ ‚Üí
                </button>
            `;
        }

        async function loadQueueStats() {
            try {
                const response = await fetch(`${API_BASE}/message-queue/status`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                
                if (stats.available) {
                    document.getElementById('queueTotal').textContent = stats.total || 0;
                    document.getElementById('queuePending').textContent = stats.stats.pending || 0;
                    document.getElementById('queueSent').textContent = stats.stats.sent || 0;
                    document.getElementById('queueFailed').textContent = stats.stats.failed || 0;
                } else {
                    document.getElementById('queueTotal').textContent = '-';
                    document.getElementById('queuePending').textContent = '-';
                    document.getElementById('queueSent').textContent = '-';
                    document.getElementById('queueFailed').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading queue stats:', error);
            }
        }

        async function clearWebhookLogs() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤–µ–±—Ö—É–∫–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            try {
                const response = await fetch(`${API_BASE}/webhook-logs`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (response.ok) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                    document.getElementById('logDetails').style.display = 'none';
                    document.getElementById('logDetailsPlaceholder').style.display = 'block';
                    document.getElementById('logDetailsContent').innerHTML = '';
                    
                    loadWebhookLogs();
                    showAlert('logsAlert', '–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞', 'success');
                } else {
                    showAlert('logsAlert', '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
                }
            } catch (error) {
                showAlert('logsAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function saveTestBotToken() {
            const token = document.getElementById('testBotToken').value.trim();
            if (!token) {
                const resultDiv = document.getElementById('telegramTestResult');
                resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞:</strong> –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞`;
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
                return false;
            }
            
            if (token === 'YOUR_TOKEN') {
                const resultDiv = document.getElementById('telegramTestResult');
                resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞:</strong> –í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞, –∞ –Ω–µ "YOUR_TOKEN"`;
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
                return false;
            }
            
            try {
                const response = await fetch('/api/bot-token', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ botToken: token })
                });
                
                if (response.ok) {
                    const resultDiv = document.getElementById('telegramTestResult');
                    resultDiv.innerHTML = `‚úÖ <strong>–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</strong> –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –û–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª –±–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.`;
                    resultDiv.className = 'test-result success';
                    resultDiv.style.display = 'block';
                    return true;
                } else {
                    const error = await response.json();
                    const resultDiv = document.getElementById('telegramTestResult');
                    resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</strong> ${error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω'}`;
                    resultDiv.className = 'test-result error';
                    resultDiv.style.display = 'block';
                    return false;
                }
            } catch (error) {
                const resultDiv = document.getElementById('telegramTestResult');
                resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
                return false;
            }
        }

        async function exportRules(selectedIds = null) {
            try {
                const response = await fetch(`${API_BASE}/rules`, { headers: getHeaders() });
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞');
                }
                let allRules = await response.json();
                
                let rulesToExport;
                if (selectedIds) {
                    rulesToExport = allRules.filter(rule => selectedIds.includes(rule.id));
                } else {
                    rulesToExport = allRules;
                }
                
                if (rulesToExport.length === 0) {
                    showAlert('rulesAlert', '–ù–µ—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                    return;
                }
                
                const dataStr = JSON.stringify(rulesToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const exportFileDefaultName = `telegram-webhook-rules-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.href = url;
                linkElement.download = exportFileDefaultName;
                linkElement.style.display = 'none';
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                URL.revokeObjectURL(url);
                
                showAlert('rulesAlert', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${rulesToExport.length} –ø—Ä–∞–≤–∏–ª`, 'success');
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }

        function importRules(e) {
            console.log('importRules called', e.target.files);
            const file = e.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            console.log('File selected:', file.name, file.size, file.type);
            if (!file.name.endsWith('.json')) {
                showAlert('rulesAlert', '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .json', 'error');
                document.getElementById('importFile').value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    console.log('File loaded, parsing JSON');
                    const rules = JSON.parse(event.target.result);
                    console.log('Parsed rules:', rules);
                    if (!Array.isArray(rules)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤ –ø—Ä–∞–≤–∏–ª');
                    if (rules.length === 0) throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª');
                    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${rules.length} –ø—Ä–∞–≤–∏–ª? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å, –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) return;

                    const needFallback = rules.some(r => !r.botToken || typeof r.botToken !== 'string' || r.botToken.includes('*') || r.botToken === 'YOUR_TOKEN');
                    if (needFallback) { _pendingImportRules = rules; showImportTokenModal(); return; }

                    await performImport(rules, null);
                } catch (error) {
                    showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
                    document.getElementById('importFile').value = '';
                }
            };
            reader.onerror = function() {
                console.error('File read error');
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
                document.getElementById('importFile').value = '';
            };
            reader.readAsText(file);
        }

        function showInstructionsModal() {
            const modal = document.getElementById('instructionsModal');
            if (modal) {
                updateWebhookUrl(); // –û–±–Ω–æ–≤–ª—è–µ–º URL –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
                modal.style.display = 'flex';
            }
        }

        function closeInstructionsModal(event) {
            // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ —Ñ–æ–Ω—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (event && event.target !== event.currentTarget && event.target.closest('.modal-content')) {
                return;
            }
            const modal = document.getElementById('instructionsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showExportImportModal() {
            const modal = document.getElementById('exportImportModal');
            const rulesList = document.getElementById('exportRulesList');
            
            if (modal && rulesList) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                fetch(`${API_BASE}/rules`, { headers: getHeaders() })
                    .then(response => response.json())
                    .then(rules => {
                        rulesList.innerHTML = rules.map(rule => `
                            <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid hsl(var(--border)); border-radius: 4px;">
                                <input type="checkbox" class="export-rule-checkbox" value="${rule.id}" style="margin-right: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${escapeHtml(rule.name)}</div>
                                    <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                        ${rule.enabled ? '‚úÖ –í–∫–ª' : '‚è∏Ô∏è –í—ã–∫–ª'} ‚Ä¢ ${escapeHtml(rule.condition)} ‚Ä¢ ${escapeHtml(rule.chatId)}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
                        const selectAllCheckbox = document.getElementById('selectAllExportRules');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.addEventListener('change', function() {
                                const checkboxes = document.querySelectorAll('.export-rule-checkbox');
                                checkboxes.forEach(cb => cb.checked = this.checked);
                            });
                        }
                        
                        modal.style.display = 'flex';
                    })
                    .catch(error => {
                        rulesList.innerHTML = '<div class="alert error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª</div>';
                        modal.style.display = 'flex';
                    });
            }
        }

        function closeExportImportModal(event) {
            // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ —Ñ–æ–Ω—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (event && event.target !== event.currentTarget && event.target.closest('.modal-content')) {
                return;
            }
            const modal = document.getElementById('exportImportModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function exportSelectedRules() {
            const selectedCheckboxes = document.querySelectorAll('.export-rule-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('rulesAlert', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            await exportRules(selectedIds);
        }

        async function exportAllRules() {
            await exportRules(null); // null –æ–∑–Ω–∞—á–∞–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞
        }

        function copyWebhookUrlFromModal() {
            const urlElement = document.getElementById('webhookUrlModal');
            if (urlElement) {
                const url = urlElement.textContent;
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('rulesAlert', 'Webhook URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                }).catch(err => {
                    showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message, 'error');
                });
            }
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('button[onclick="copyWebhookUrl()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        function showImportTokenModal() {
            document.getElementById('importTokenInput').value = '';
            document.getElementById('importTokenAlert').className = 'alert';
            document.getElementById('importTokenModal').style.display = 'flex';
        }

        function hideImportTokenModal() {
            document.getElementById('importTokenModal').style.display = 'none';
        }

        function cancelImportToken() {
            _pendingImportRules = null;
            hideImportTokenModal();
            showAlert('rulesAlert', '–ò–º–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω—ë–Ω', 'info');
            document.getElementById('importFile').value = '';
        }

        async function confirmImportToken() {
            const token = document.getElementById('importTokenInput').value.trim();
            if (!token) {
                showAlert('importTokenAlert', '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }
            hideImportTokenModal();
            if (_pendingImportRules) {
                const rules = _pendingImportRules;
                _pendingImportRules = null;
                await performImport(rules, token);
            }
        }

        async function performImport(rules, fallbackToken) {
            try {
                // First load existing rules and try to delete only those we are allowed to delete
                const existingRulesResponse = await fetch('/api/rules', { headers: getHeaders() });
                if (!existingRulesResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞');
                }
                const existingRules = await existingRulesResponse.json();

                let deletedCount = 0;
                let skippedDeletes = 0;
                for (const rule of existingRules) {
                    const canDelete = (currentUserData && (currentUserData.username === 'vadmin' || (rule.authorId && typeof rule.authorId === 'number' && rule.authorId === currentUserData.userId)));
                    if (!canDelete) { skippedDeletes++; continue; }
                    try {
                        const deleteResponse = await fetch(`/api/rules/${rule.id}`, { method: 'DELETE', headers: getHeaders() });
                        if (deleteResponse.ok) deletedCount++; else skippedDeletes++;
                    } catch (err) {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ ${rule.id}:`, err);
                        skippedDeletes++;
                    }
                }

                // Then add the new rules (preserve chatIds or chatId)
                let importedCount = 0;
                let failedCount = 0;
                for (const rule of rules) {
                    try {
                        const body = { name: rule.name, condition: rule.condition, messageTemplate: rule.messageTemplate || null, enabled: rule.enabled !== false };
                        if (Array.isArray(rule.chatIds) && rule.chatIds.length > 0) body.chatIds = rule.chatIds; else if (rule.chatId) body.chatId = rule.chatId;
                        const token = (rule.botToken && typeof rule.botToken === 'string' && !rule.botToken.includes('*') && rule.botToken !== 'YOUR_TOKEN') ? rule.botToken : fallbackToken;
                        if (!token || typeof token !== 'string' || !token.trim()) {
                            console.error(`–ü—Ä–æ–ø—É—â–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ "${rule.name}": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω`);
                            failedCount++;
                            continue;
                        }
                        body.botToken = token;

                        const createResponse = await fetch('/api/rules', { method: 'POST', headers: getHeaders(), body: JSON.stringify(body) });
                        if (!createResponse.ok) { const errorData = await createResponse.json().catch(() => ({})); console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ "${rule.name}":`, errorData); failedCount++; } else { importedCount++; }
                    } catch (err) { console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ "${rule.name}":`, err); failedCount++; }
                }

                if (failedCount > 0) {
                    showAlert('rulesAlert', `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –∏–∑ ${rules.length} –ø—Ä–∞–≤–∏–ª. –û—à–∏–±–æ–∫: ${failedCount}. –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª: ${deletedCount}. –ü—Ä–æ–ø—É—â–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ: ${skippedDeletes}.`, 'warning');
                } else {
                    showAlert('rulesAlert', `–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –ø—Ä–∞–≤–∏–ª. –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª: ${deletedCount}. –ü—Ä–æ–ø—É—â–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ: ${skippedDeletes}.`, 'success');
                }

                await loadRules();
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            } finally {
                document.getElementById('importFile').value = '';
            }
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            if (!alert) return;
            
            alert.textContent = message;
            alert.className = `alert show alert-${type}`;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/[&<>"']/g, m => 
                ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])
            );
        }

        // User management functions
        let currentUserId = null;
        let currentUserData = null; // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        let usersCache = null; // –ö—ç—à —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω –∞–≤—Ç–æ—Ä–æ–≤

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, { headers: getHeaders() });
                if (!response.ok) {
                    if (response.status === 403) {
                        return; // –ù–µ vadmin, –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    }
                    throw new Error('Failed to load users');
                }
                const users = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω –∞–≤—Ç–æ—Ä–æ–≤
                usersCache = users;
                
                const container = document.getElementById('usersList');
                if (!container) return;
                
                if (users.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º vadmin –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                const allUsers = [{ id: 'vadmin', username: 'vadmin', created_at: null, isVadmin: true }, ...users];
                
                container.innerHTML = allUsers.map(user => `
                    <div class="rule-item" data-id="${user.id || 'vadmin'}">
                        <div class="rule-content">
                            <div class="rule-name">
                                üë§ ${escapeHtml(user.username)} ${user.isVadmin ? '<span style="color: #667eea;">(vadmin)</span>' : ''}
                            </div>
                            ${user.created_at ? `<div class="rule-channel">üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(user.created_at).toLocaleString('ru-RU')}</div>` : '<div class="rule-channel">üìÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>'}
                        </div>
                        <div class="rule-actions">
                            ${!user.isVadmin ? `<button class="btn-danger btn-small" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                const container = document.getElementById('usersList');
                if (container) {
                    container.innerHTML = `<p style="color: #f44336; text-align: center; padding: 40px 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${error.message}</p>`;
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—ç—à–∞ (–±–µ–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        async function loadUsersForCache() {
            try {
                const response = await fetch(`${API_BASE}/users`, { headers: getHeaders() });
                if (response.ok) {
                    const users = await response.json();
                    usersCache = users;
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥–µ—Ç –∫—ç—à–∞
                console.debug('Could not load users for cache:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª–∞
        function getAuthorName(authorId) {
            if (!authorId) {
                return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
            
            if (authorId === 'vadmin') {
                return 'vadmin';
            }
            
            if (typeof authorId === 'number' && usersCache) {
                const user = usersCache.find(u => u.id === authorId);
                if (user) {
                    return user.username;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∫—ç—à–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ID
            return typeof authorId === 'number' ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${authorId}` : String(authorId);
        }

        function showCreateUserForm() {
            document.getElementById('createUserCard').style.display = 'block';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserAlert').className = 'alert';
        }

        function cancelCreateUser() {
            document.getElementById('createUserCard').style.display = 'none';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserAlert').className = 'alert';
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!username || !password) {
                showAlert('createUserAlert', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    showAlert('createUserAlert', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
                    document.getElementById('createUserForm').reset();
                    setTimeout(() => {
                        cancelCreateUser();
                        loadUsers();
                    }, 1500);
                } else {
                    const data = await response.json();
                    showAlert('createUserAlert', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('createUserAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        async function deleteUser(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showAlert('usersAlert', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                    loadUsers();
                } else {
                    const data = await response.json();
                    showAlert('usersAlert', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('usersAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Change password functions
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordAlert').className = 'alert';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordAlert').className = 'alert';
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('changePasswordAlert', '–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
                const meResponse = await fetch(`${API_BASE}/me`, { headers: getHeaders() });
                if (!meResponse.ok) throw new Error('Failed to get current user');
                const meData = await meResponse.json();
                
                // –î–ª—è vadmin —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                if (meData.username === 'vadmin') {
                    showAlert('changePasswordAlert', '–î–ª—è vadmin —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.', 'error');
                    return;
                }
                
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º userId –∏–∑ –æ—Ç–≤–µ—Ç–∞ /api/me
                const userId = meData.userId;
                if (!userId) {
                    showAlert('changePasswordAlert', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/users/${userId}/password`, {
                    method: 'PUT',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        oldPassword: meData.username === 'vadmin' ? undefined : oldPassword,
                        password: newPassword 
                    })
                });
                
                if (response.ok) {
                    showAlert('changePasswordAlert', '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 1500);
                } else {
                    const data = await response.json();
                    showAlert('changePasswordAlert', data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('changePasswordAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>