<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Webhook Integration</title>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
            --shadow: 222.2 84% 4.9%;
            --success: 120 99% 38%;
            --warning: 45 100% 50%;
            --info: 210 100% 50%;
        }

        :root.dark-theme {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 216 12% 17%;
            --card-foreground: 210 40% 98%;
            --popover: 216 12% 17%;
            --popover-foreground: 210 40% 98%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 216 10% 25%;
            --secondary-foreground: 210 40% 98%;
            --muted: 216 10% 25%;
            --muted-foreground: 215.4 16.3% 66.9%;
            --accent: 216 10% 25%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 216 10% 30%;
            --input: 216 10% 30%;
            --ring: 221.2 83.2% 53.3%;
            --shadow: 222.2 84% 4.9%;
            --success: 120 99% 38%;
            --warning: 45 100% 50%;
            --info: 210 100% 50%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)));
            color: hsl(var(--foreground));
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color 0.3s ease;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)));
            z-index: 9999;
            transition: background 0.3s ease;
        }

        .login-container.hidden {
            display: none;
        }

        .login-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 100%;
            max-width: 400px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .login-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .login-card h1 {
            color: hsl(var(--foreground));
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-card p {
            color: hsl(var(--muted-foreground));
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-form-group {
            margin-bottom: 1.5rem;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            font-weight: 500;
            font-size: 0.875rem;
        }

        .login-form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid hsl(var(--input));
            border-radius: var(--radius);
            font-size: 1rem;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .login-alert {
            display: none;
            padding: 0.75rem;
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border: 1px solid hsl(var(--destructive) / 0.2);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .login-alert.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: hsl(var(--foreground));
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        header h1 {
            font-size: 2.5rem;
            margin: 0;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .theme-toggle {
            position: relative;
            z-index: 10;
        }

        .icon-btn {
            background: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: hsl(var(--secondary-foreground));
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: hsl(var(--accent));
        }

        .logout-btn {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: hsl(var(--accent));
        }

        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 2px solid hsl(var(--primary));
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .card-header h2 {
            color: hsl(var(--foreground));
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header-icon {
            transition: transform 0.3s ease;
        }

        .card-header.collapsed .card-header-icon {
            transform: rotate(-90deg);
        }

        .card-content {
            padding: 0 2rem;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .card-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-hint {
            color: hsl(var(--muted-foreground));
            font-size: 0.8125rem;
            margin-top: 0.3125rem;
            display: block;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid hsl(var(--input));
            border-radius: var(--radius);
            font-size: 1rem;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 6rem;
            font-family: 'Courier New', monospace;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }

        .btn-secondary:hover {
            background: hsl(var(--accent));
        }

        .btn-danger {
            background: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .btn-danger:hover {
            background: hsl(var(--destructive) / 0.9);
        }

        .btn-test {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-test:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid hsl(var(--border));
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            min-width: auto;
        }

        .btn-success {
            background: hsl(var(--success));
            color: white;
        }

        .btn-warning {
            background: hsl(var(--warning));
            color: white;
        }

        .btn-info {
            background: hsl(var(--info));
            color: white;
        }

        .rules-list {
            max-height: 37.5rem;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .rule-item {
            background: hsl(var(--muted));
            border-left: 4px solid hsl(var(--primary));
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .rule-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rule-item.disabled {
            opacity: 0.6;
            border-left-color: hsl(var(--muted-foreground));
        }

        .rule-item.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .rule-content {
            flex: 1;
        }

        .rule-name {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-condition {
            background: hsl(var(--background));
            padding: 0.625rem;
            border-radius: calc(var(--radius) - 2px);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.5rem;
            word-break: break-word;
            border: 1px solid hsl(var(--border));
        }

        .rule-channel {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        .rule-bot {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .rule-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 120px;
        }

        .rule-status {
            display: flex;
            gap: 5px;
            align-items: center;
            font-size: 0.85em;
            margin-top: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
        }

        .status-badge.disabled {
            background: #999;
        }

        .alert {
            padding: 1rem;
            border-radius: calc(var(--radius) - 2px);
            margin-bottom: 1rem;
            display: none;
            border: 1px solid hsl(var(--border));
            animation: fadeIn 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: hsl(var(--success) / 0.15);
            color: hsl(var(--success));
            border-color: hsl(var(--success) / 0.3);
        }

        .alert-error {
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border-color: hsl(var(--destructive) / 0.3);
        }

        .alert-info {
            background: hsl(var(--info) / 0.1);
            color: hsl(var(--info));
            border-color: hsl(var(--info) / 0.3);
        }

        .alert-warning {
            background: hsl(var(--warning) / 0.1);
            color: hsl(var(--warning));
            border-color: hsl(var(--warning) / 0.3);
        }

        .instructions {
            background: hsl(var(--muted));
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: hsl(var(--shadow) / 0.1) 0px 4px 6px -1px, hsl(var(--shadow) / 0.1) 0px 2px 4px -2px;
            color: hsl(var(--foreground));
            margin-top: 1rem;
        }

        .instructions h3 {
            color: hsl(var(--primary));
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instructions h3:first-child {
            margin-top: 0;
        }

        .instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }

        .dark-theme .instructions code {
            background: #444;
            color: #ff7070;
        }

        .instructions pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .dark-theme .instructions pre {
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .instructions ul,
        .instructions ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .webhook-url {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .dark-theme .webhook-url {
            background: #333;
            border-color: #555;
            color: #fff;
        }

        .test-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid hsl(var(--border));
        }

        .test-result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            display: none;
            border-left: 4px solid #6c757d;
        }

        .dark-theme .test-result {
            background: #333;
            color: #fff;
        }

        .test-result.success {
            border-left-color: hsl(var(--success));
        }

        .test-result.error {
            border-left-color: hsl(var(--destructive));
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: hsl(var(--card));
            border-radius: var(--radius);
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid hsl(var(--border));
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Tabs styles */
        .tabs-container {
            margin-bottom: 2rem;
        }

        .tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 2px solid hsl(var(--border));
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: hsl(var(--secondary));
            border: none;
            border-radius: var(--radius) var(--radius) 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: hsl(var(--accent));
        }

        .tab.active {
            background: hsl(var(--card));
            border-bottom: 2px solid hsl(var(--primary));
            font-weight: 600;
        }

        .tab-content {
            position: relative;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Rules toolbar styles */
        .rules-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0 1rem;
        }

        .rules-toolbar h2 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .rules-search {
            position: relative;
            width: 250px;
        }

        .rules-search input {
            padding-left: 2.5rem;
        }

        .rules-search::before {
            content: "üîç";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: hsl(var(--muted-foreground));
            font-size: 1rem;
        }

        /* Create rule button */
        .create-rule-btn {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .create-rule-btn:hover {
            background: hsl(var(--primary) / 0.9);
            transform: translateY(-1px);
        }

        /* Logs styles */
        .logs-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logs-toolbar h2 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .logs-actions {
            display: flex;
            gap: 0.75rem;
        }

        .logs-container {
            max-height: 40rem;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .log-item {
            border-bottom: 1px solid hsl(var(--border));
            padding: 0.625rem 0;
            color: hsl(var(--foreground));
        }

        .log-timestamp {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
        }

        .log-payload {
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            padding: 0.5rem;
            margin: 0.3125rem 0;
            font-size: 0.875rem;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            max-height: 15rem;
            overflow: auto;
        }

        .log-match {
            margin-top: 0.3125rem;
            font-weight: 500;
        }

        .log-telegram {
            margin-top: 0.3125rem;
        }

        .log-telegram-item {
            margin: 0.25rem 0;
            padding-left: 1.25rem;
        }

        .log-success {
            color: hsl(var(--success));
        }

        .log-error {
            color: hsl(var(--destructive));
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .page-btn {
            background: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: hsl(var(--accent));
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        /* Condition builder */
        .condition-builder {
            background: hsl(var(--muted));
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .condition-mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .condition-mode-toggle label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .condition-groups {
            margin-bottom: 1.5rem;
        }

        .condition-group {
            background: hsl(var(--background));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .condition-rows {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .condition-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .condition-row select, 
        .condition-row input {
            flex: 1;
            min-width: 150px;
        }

        .add-condition-btn {
            background: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-condition-btn:hover {
            background: hsl(var(--accent));
        }

        .remove-condition-btn {
            background: hsl(var(--destructive));
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0;
        }

        .condition-logic {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .preview-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid hsl(var(--primary));
        }

        .preview-result {
            background: hsl(var(--background));
            border-radius: calc(var(--radius) - 2px);
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            border: 1px solid hsl(var(--border));
        }

        .telegram-preview {
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            overflow: hidden;
            background: #eaeaea;
            max-width: 400px;
            margin: 0 auto;
        }

        .telegram-message {
            display: flex;
            padding: 0.75rem;
            background: white;
        }

        .telegram-avatar {
            width: 40px;
            height: 40px;
            background: #0088cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .telegram-content {
            flex: 1;
        }

        .telegram-sender {
            font-weight: 600;
            color: #000;
            margin-bottom: 0.25rem;
        }

        .telegram-text {
            color: #333;
            line-height: 1.5;
            font-size: 0.9375rem;
            white-space: pre-line;
        }

        .telegram-time {
            color: #999;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .code-condition-editor {
            margin-top: 1rem;
        }

        /* Input with button */
        .input-with-button {
            position: relative;
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button button {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            padding: 0;
        }

        /* Export/import section */
        .export-import-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid hsl(var(--border));
        }

        .export-import-section h3 {
            margin-top: 0;
            color: hsl(var(--primary));
            border: none;
            padding: 0;
        }

        .skeleton {
            background: linear-gradient(90deg, 
                hsl(var(--muted)) 0%, 
                hsl(var(--muted) / 0.8) 50%, 
                hsl(var(--muted)) 100%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
            }

            header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .rules-toolbar, .logs-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .rules-search {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
            }

            .rule-item {
                flex-direction: column;
            }

            .rule-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .condition-row {
                flex-direction: column;
                align-items: stretch;
            }

            .telegram-preview {
                max-width: 100%;
            }
            
            .create-rule-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1>üîê –í—Ö–æ–¥</h1>
            <p>Telegram Webhook Integration</p>

            <div id="loginAlert" class="login-alert"></div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label for="username">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="username" placeholder="vadmin" required>
                </div>

                <div class="login-form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp" style="display: none;">
        <div class="container">
            <header>
                <h1>üì± Telegram Webhook Integration üí≤VadminLink</h1>
                <div class="header-actions">
                    <span id="currentUsername" style="margin-right: 1rem; color: hsl(var(--muted-foreground));"></span>
                    <button class="logout-btn" onclick="showChangePasswordModal()" style="margin-right: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                    <div class="theme-toggle">
                        <button id="themeToggle" class="icon-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.43 7.508 7.508 0 0 0 1.107-3.43A9.5 9.5 0 0 1 6 12c0 2.62.676 5.067 1.868 7.083a7.5 7.5 0 0 0 3.956-11.81 7.5 7.5 0 0 0-7.452-4.273A9.5 9.5 0 0 1 12 3z"></path>
                            </svg>
                        </button>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        –í—ã—Ö–æ–¥
                    </button>
                </div>
            </header>

            <!-- Modal for change password -->
            <div id="changePasswordModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2>
                        <button class="icon-btn" onclick="closeChangePasswordModal()" style="margin-left: auto;">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div id="changePasswordAlert" class="alert"></div>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label for="oldPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="oldPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label for="newPasswordChange">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="newPasswordChange" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                                <button type="button" class="btn-secondary" onclick="closeChangePasswordModal()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="rules">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                        </svg>
                        –ü—Ä–∞–≤–∏–ª–∞
                    </button>
                    <button class="tab" data-tab="test">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </button>
                    <button class="tab" data-tab="history">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="12 6 12 12 16 14"></polyline>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        –ò—Å—Ç–æ—Ä–∏—è
                    </button>
                    <button class="tab" data-tab="instructions">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    </button>
                    <button class="tab" data-tab="users" id="usersTab" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </button>
                </div>
                
                <div class="tab-content">
                    <div id="rules-tab" class="tab-pane active">
                        <div class="content">
                            <!-- Collapsible card for rule creation -->
                            <div class="card">
                                <div class="card-header" id="createRuleHeader">
                                    <h2>
                                        <svg class="card-header-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ
                                    </h2>
                                    <button class="btn-primary" id="toggleCreateRule">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div class="card-content collapsed" id="createRuleContent">
                                    <div id="addAlert" class="alert"></div>

                                    <form id="ruleForm">
                                        <div class="form-group">
                                            <label for="ruleName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</label>
                                            <input type="text" id="ruleName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç" required>
                                            <small class="form-hint">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</small>
                                        </div>

                                        <div class="form-group">
                                            <label for="condition">–£—Å–ª–æ–≤–∏–µ (JavaScript –≤—ã—Ä–∞–∂–µ–Ω–∏–µ)</label>
                                            <div class="condition-builder">
                                                <div class="condition-mode-toggle">
                                                    <label>
                                                        <input type="radio" name="conditionMode" value="visual" checked>
                                                        –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="conditionMode" value="code">
                                                        –†—É—á–Ω–æ–π –≤–≤–æ–¥ (JavaScript)
                                                    </label>
                                                </div>
                                                
                                                <div class="visual-condition-editor" id="visualConditionEditor">
                                                    <div class="condition-groups">
                                                        <div class="condition-group">
                                                            <div class="condition-rows">
                                                                <div class="condition-row">
                                                                    <select class="field-select">
                                                                        <option value="payload.team_id">ID –∫–æ–º–∞–Ω–¥—ã</option>
                                                                        <option value="payload.team.name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</option>
                                                                        <option value="payload.status">–°—Ç–∞—Ç—É—Å</option>
                                                                        <option value="payload.category" selected>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                                                        <option value="payload.impact">–í–ª–∏—è–Ω–∏–µ</option>
                                                                        <option value="payload.priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                                                                        <option value="payload.requested_by.name">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</option>
                                                                    </select>
                                                                    <select class="operator-select">
                                                                        <option value="===" selected>—Ä–∞–≤–Ω–æ</option>
                                                                        <option value="!==">–Ω–µ —Ä–∞–≤–Ω–æ</option>
                                                                        <option value=">">–±–æ–ª—å—à–µ</option>
                                                                        <option value="<">–º–µ–Ω—å—à–µ</option>
                                                                        <option value="includes">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                                                                    </select>
                                                                    <input type="text" class="value-input" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="incident">
                                                                </div>
                                                            </div>
                                                            <button class="add-condition-btn">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                                </svg>
                                                                –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="condition-logic">
                                                        <label>
                                                            <input type="radio" name="groupLogic" value="AND" checked>
                                                            –ò (AND) - –≤—Å–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
                                                        </label>
                                                        <label>
                                                            <input type="radio" name="groupLogic" value="OR">
                                                            –ò–õ–ò (OR) - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div class="code-condition-editor" id="codeConditionEditor" style="display: none;">
                                                    <textarea id="conditionCode" placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: payload.category === "incident" && payload.impact === "high"'>payload.category === "incident"</textarea>
                                                    <small class="form-hint">–î–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è <code>payload</code> —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–µ–±—Ö—É–∫–∞</small>
                                                </div>
                                                
                                                <div class="preview-section">
                                                    <h3>üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —É—Å–ª–æ–≤–∏—è</h3>
                                                    <div class="preview-result">
                                                        <strong>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:</strong>
                                                        <pre id="conditionPreview">payload.category === "incident"</pre>
                                                    </div>
                                                    
                                                    <input type="hidden" id="condition" value='payload.category === "incident"'>
                                                    
                                                    <h3>üì± –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                                                    <div class="telegram-preview">
                                                        <div class="telegram-message">
                                                            <div class="telegram-avatar">ü§ñ</div>
                                                            <div class="telegram-content">
                                                                <div class="telegram-sender">Webhook Bot</div>
                                                                <div class="telegram-text" id="messagePreview">
                                                                    üÜî ID: 141<br><br>
                                                                    üìã –¢–µ–º–∞: –ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è<br><br>
                                                                    üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞: –ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è @–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç<br><br>
                                                                    –ö–æ–º–∞–Ω–¥–∞: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
                                                                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: incident<br>
                                                                    –í–ª–∏—è–Ω–∏–µ: medium<br><br>
                                                                    üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:<br>
                                                                    1. –ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π @–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç (07.01.2026, 16:36): avwqrgw
                                                                </div>
                                                                <div class="telegram-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="chatId">ID Telegram —á–∞—Ç–∞</label>
                                            <input type="text" id="chatId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890" required>
                                            <small class="form-hint">–î–ª—è –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.</small>
                                        </div>

                                        <div class="form-group">
                                            <label for="botToken">–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                            <div class="input-with-button">
                                                <input type="password" id="botToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" required>
                                                <button type="button" class="toggle-password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
                                            </div>
                                            <small class="form-hint">–ü–æ–ª—É—á–∏—Ç–µ –æ—Ç @BotFather –≤ Telegram. –ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞.</small>
                                        </div>

                                        <div class="form-group">
                                            <label for="messageTemplate">–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                            <textarea id="messageTemplate" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª–Ω–æ–≥–æ payload"></textarea>
                                            <small class="form-hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>${'{payload}'}</code> –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω.</small>
                                        </div>

                                        <div class="form-group checkbox-group">
                                            <input type="checkbox" id="enabled" checked>
                                            <label for="enabled" style="margin: 0;">–í–∫–ª—é—á–µ–Ω–æ</label>
                                        </div>

                                        <div class="button-group">
                                            <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
                                            <button type="reset" class="btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="rules-toolbar">
                                    <h2>üìã –ú–æ–∏ –ø—Ä–∞–≤–∏–ª–∞</h2>
                                    <div class="rules-search">
                                        <input type="text" id="rulesSearch" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∏–ª...">
                                    </div>
                                </div>
                                
                                <div id="rulesAlert" class="alert"></div>

                                <div id="rulesList" class="rules-list">
                                    <p style="color: #999; text-align: center; padding: 40px 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="test-tab" class="tab-pane">
                        <div class="content">
                            <div class="card">
                                <h2>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π</h2>
                                <div class="form-group">
                                    <label for="testCondition">–£—Å–ª–æ–≤–∏–µ</label>
                                    <input type="text" id="testCondition" placeholder='payload.team_id === 40' value='payload.category === "incident"'>
                                </div>
                                <div class="form-group">
                                    <label for="testPayload">–¢–µ—Å—Ç–æ–≤—ã–π payload (JSON)</label>
                                    <textarea id="testPayload" placeholder='{"team_id": 40, "name": "Test"}'>{
  "team_id": 40,
  "team": {
    "id": 40,
    "name": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
  },
  "category": "incident",
  "impact": "medium",
  "subject": "–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è",
  "requested_by": {
    "name": "–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è",
    "account": {
      "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
    }
  },
  "note": [
    {
      "text": "avwqrgw",
      "person": {
        "name": "–ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π"
      },
      "account": {
        "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
      },
      "created_at": "2026-01-07T16:36:27Z"
    }
  ],
  "resolution_target_at": "2024-07-29T19:20:00Z",
  "response_target_at": "2024-07-26T21:50:00Z"
}</textarea>
                                    <small class="form-hint">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä payload –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>
                                </div>
                                <button class="btn-test" onclick="testCondition()">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–∏–µ</button>
                                <div id="testResult" class="test-result"></div>
                            </div>
                            
                            <div class="card">
                                <h2>üì§ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram</h2>
                                <div class="form-group">
                                    <label for="testChatId">ID —á–∞—Ç–∞</label>
                                    <input type="text" id="testChatId" placeholder="-1001234567890">
                                    <small class="form-hint">ID —á–∞—Ç–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª–∞ –≤ Telegram</small>
                                </div>
                                <div class="form-group">
                                    <label for="testMessage">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                                    <textarea id="testMessage" placeholder="–ü—Ä–∏–≤–µ—Ç –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!">–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</textarea>
                                </div>
                                <button class="btn-primary" onclick="testTelegramSend()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                                <div id="telegramTestResult" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <div id="history-tab" class="tab-pane">
                        <div class="card">
                            <div class="logs-toolbar">
                                <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –≤–µ–±—Ö—É–∫–æ–≤</h2>
                                <div class="logs-actions">
                                    <button class="btn-secondary" onclick="loadWebhookLogs()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                        </svg>
                                        –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                    <button class="btn-danger" onclick="clearWebhookLogs()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                        –û—á–∏—Å—Ç–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            
                            <div id="logsContainer" class="logs-container skeleton">
                                <p style="color: hsl(var(--muted-foreground)); text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                            </div>
                            
                            <div class="pagination">
                                <button class="page-btn prev" disabled>‚Üê –ü—Ä–µ–¥</button>
                                <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
                                <button class="page-btn next" disabled>–°–ª–µ–¥ ‚Üí</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="instructions-tab" class="tab-pane">
                        <div class="content">
                            <div class="card">
                                <h2>üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h2>
                                <ol>
                                    <li>–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç <code>@BotFather</code> –≤ Telegram</li>
                                    <li>–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–æ–ª–µ "–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞" –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ</li>
                                    <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–æ–≤</li>
                                </ol>

                                <h3>üìù –ü—Ä–∏–º–µ—Ä—ã —É—Å–ª–æ–≤–∏–π</h3>
                                <ul>
                                    <li><code>payload.team_id === 40</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ID –∫–æ–º–∞–Ω–¥—ã (—á–∏—Å–ª–æ)</li>
                                    <li><code>payload.team.name === "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–∞–Ω–¥—ã</li>
                                    <li><code>payload.status === "error"</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</li>
                                    <li><code>payload.impact === "high"</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∏—è–Ω–∏—è</li>
                                    <li><code>payload.subject.includes("—Å–µ—Ä–≤–µ—Ä")</code> - –ø–æ–∏—Å–∫ –≤ —Ç–µ–º–µ</li>
                                    <li><code>payload.note && payload.note.some(n => n.text.includes("—Å—Ä–æ—á–Ω–æ"))</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</li>
                                    <li><code>new Date(payload.created_at) > new Date(Date.now() - 3600000)</code> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è</li>
                                    <li><code>payload.category === "incident" && payload.impact === "high"</code> - –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª–æ–≤–∏–π</li>
                                </ul>

                                <h3>üîó Webhook URL</h3>
                                <p>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å:</p>
                                <div class="webhook-url" id="webhookUrl">http://localhost:3000/webhook</div>
                                <button class="btn-secondary btn-small" onclick="copyWebhookUrl()" style="margin-top: 0.5rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </button>

                                <h3>üìã –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞</h3>
                                <pre>curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "team_id": 40,
    "team": {
      "id": 40,
      "name": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    },
    "category": "incident",
    "impact": "medium",
    "subject": "–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è",
    "requested_by": {
      "name": "–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è",
      "account": {
        "name": "–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç"
      }
    }
  }'</pre>
                            </div>
                            
                            <div class="card">
                                <h2>üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                                <div class="form-group">
                                    <label for="globalBotToken">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π)</label>
                                    <div class="input-with-button">
                                        <input type="password" id="globalBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                                        <button type="button" class="toggle-password-global" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
                                    </div>
                                    <small class="form-hint">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –≤ –ø—Ä–∞–≤–∏–ª–µ –Ω–µ —É–∫–∞–∑–∞–Ω —Ç–æ–∫–µ–Ω. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º.</small>
                                </div>
                                <button class="btn-primary" onclick="saveGlobalBotToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
                                
                                <div class="export-import-section">
                                    <h3>üíæ –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª</h3>
                                    <div class="button-group">
                                        <button class="btn-secondary" onclick="exportRules()">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞</button>
                                        <button class="btn-secondary" onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞</button>
                                        <input type="file" id="importFile" accept=".json" style="display: none;">
                                    </div>
                                    <small class="form-hint">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –º–µ–∂–¥—É —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="users-tab" class="tab-pane">
                        <div class="content">
                            <div class="card" id="createUserCard" style="display: none;">
                                <div class="card-header">
                                    <h2>üë§ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                                </div>
                                <div class="card-content">
                                    <div id="createUserAlert" class="alert"></div>
                                    <form id="createUserForm">
                                        <div class="form-group">
                                            <label for="newUsername">–õ–æ–≥–∏–Ω</label>
                                            <input type="text" id="newUsername" placeholder="username" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="newPassword">–ü–∞—Ä–æ–ª—å</label>
                                            <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                        </div>
                                        <div class="button-group">
                                            <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                                            <button type="button" class="btn-secondary" onclick="cancelCreateUser()">–û—Ç–º–µ–Ω–∞</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="rules-toolbar">
                                    <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                                    <button class="btn-primary btn-small" id="createUserBtn" onclick="showCreateUserForm()" style="display: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    </button>
                                </div>
                                
                                <div id="usersAlert" class="alert"></div>

                                <div id="usersList" class="rules-list">
                                    <p style="color: #999; text-align: center; padding: 40px 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let editingRuleId = null;
        let authToken = localStorage.getItem('authToken');
        let currentPage = 1;
        const logsPerPage = 10;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            setupEventListeners();
            loadSavedTheme();
            updateWebhookUrl();
        });

        function setupEventListeners() {
            // Forms and buttons
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('ruleForm').addEventListener('submit', saveRule);
            
            // Toggle create rule form
            document.getElementById('toggleCreateRule').addEventListener('click', toggleCreateRuleForm);
            document.getElementById('createRuleHeader').addEventListener('click', toggleCreateRuleForm);
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    if (tab.dataset.tab === 'users') {
                        loadUsers();
                    }
                });
            });
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Condition builder
            document.querySelectorAll('input[name="conditionMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('visualConditionEditor').style.display = this.value === 'visual' ? 'block' : 'none';
                    document.getElementById('codeConditionEditor').style.display = this.value === 'code' ? 'block' : 'none';
                    
                    if (this.value === 'visual') {
                        updateConditionPreview();
                    }
                });
            });
            
            // Visual condition editor
            document.querySelector('.field-select').addEventListener('change', updateConditionPreview);
            document.querySelector('.operator-select').addEventListener('change', updateConditionPreview);
            document.querySelector('.value-input').addEventListener('input', updateConditionPreview);
            document.querySelector('.add-condition-btn').addEventListener('click', addConditionRow);
            
            // Code condition editor
            document.getElementById('conditionCode').addEventListener('input', updateCodeCondition);
            
            // Password toggle
            document.querySelector('.toggle-password').addEventListener('click', function() {
                togglePasswordVisibility('#botToken', this);
            });
            
            document.querySelector('.toggle-password-global').addEventListener('click', function() {
                togglePasswordVisibility('#globalBotToken', this);
            });
            
            // Rules search
            document.getElementById('rulesSearch').addEventListener('input', function() {
                filterRules(this.value);
            });
            
            // Copy webhook URL
            document.getElementById('webhookUrl').addEventListener('click', copyWebhookUrl);
            
            // Import file
            document.getElementById('importFile').addEventListener('change', importRules);
        }

        function toggleCreateRuleForm() {
            const content = document.getElementById('createRuleContent');
            const icon = document.querySelector('#createRuleHeader .card-header-icon');
            const button = document.getElementById('toggleCreateRule');
            const arrowSvg = button.querySelector('svg');
            
            if (content.classList.contains('collapsed')) {
                // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                arrowSvg.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
                button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                
                // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ toggle –∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è
                if (!editingRuleId) {
                    document.querySelector('#createRuleHeader h2').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ';
                    document.getElementById('ruleForm').reset();
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —É—Å–ª–æ–≤–∏–π
                    document.querySelector('input[name="conditionMode"][value="visual"]').checked = true;
                    document.getElementById('visualConditionEditor').style.display = 'block';
                    document.getElementById('codeConditionEditor').style.display = 'none';
                    document.getElementById('condition').value = '';
                    document.getElementById('conditionCode').value = '';
                    updateConditionPreview();
                }
            } else {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
                if (editingRuleId) {
                    editingRuleId = null;
                    document.querySelector('#createRuleHeader h2').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ';
                    document.getElementById('ruleForm').reset();
                }
                content.style.maxHeight = content.scrollHeight + 'px';
                content.offsetHeight; // trigger reflow
                content.style.maxHeight = '0';
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                arrowSvg.innerHTML = '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>';
                button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            }
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        function togglePasswordVisibility(inputSelector, button) {
            const input = document.querySelector(inputSelector);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function addConditionRow() {
            const newRow = document.createElement('div');
            newRow.className = 'condition-row';
            newRow.innerHTML = `
                <select class="field-select">
                    <option value="payload.team_id">ID –∫–æ–º–∞–Ω–¥—ã</option>
                    <option value="payload.team.name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</option>
                    <option value="payload.status">–°—Ç–∞—Ç—É—Å</option>
                    <option value="payload.category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                    <option value="payload.impact">–í–ª–∏—è–Ω–∏–µ</option>
                    <option value="payload.priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="payload.requested_by.name">–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä</option>
                </select>
                <select class="operator-select">
                    <option value="===">—Ä–∞–≤–Ω–æ</option>
                    <option value="!==">–Ω–µ —Ä–∞–≤–Ω–æ</option>
                    <option value=">">–±–æ–ª—å—à–µ</option>
                    <option value="<">–º–µ–Ω—å—à–µ</option>
                    <option value="includes">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                </select>
                <input type="text" class="value-input" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                <button type="button" class="remove-condition-btn">-</button>
            `;
            
            document.querySelector('.condition-rows').appendChild(newRow);
            
            // Add event listeners to new elements
            newRow.querySelector('.field-select').addEventListener('change', updateConditionPreview);
            newRow.querySelector('.operator-select').addEventListener('change', updateConditionPreview);
            newRow.querySelector('.value-input').addEventListener('input', updateConditionPreview);
            newRow.querySelector('.remove-condition-btn').addEventListener('click', function() {
                newRow.remove();
                updateConditionPreview();
            });
            
            updateConditionPreview();
        }

        function updateConditionPreview() {
            const field = document.querySelector('.field-select').value;
            const operator = document.querySelector('.operator-select').value;
            const value = document.querySelector('.value-input').value;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–∞–≤—ã—á–∫–∏
            let needsQuotes = true;
            let formattedValue = value;
            
            // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π –∏ ID –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
            if (field.includes('.id') || field.includes('_id') || 
                field.includes('.priority') || 
                (field === 'payload.priority' && !isNaN(value)) ||
                (field === 'payload.team_id' && !isNaN(value))) {
                needsQuotes = false;
            }
            
            // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
            if (operator === '>' || operator === '<' || operator === '>=' || operator === '<=') {
                needsQuotes = false;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (needsQuotes) {
                // –î–ª—è boolean –∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏
                if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                    formattedValue = value.toLowerCase();
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –î–í–û–ô–ù–´–ï –∫–∞–≤—ã—á–∫–∏ –∫–∞–∫ –≤ JSON
                    formattedValue = `"${value.replace(/"/g, '\\"')}"`;
                }
            } else {
                // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                formattedValue = value.replace(/['"]/g, '');
            }
            
            const condition = `${field} ${operator} ${formattedValue}`;
            document.getElementById('conditionPreview').textContent = condition;
            document.getElementById('condition').value = condition;
            document.getElementById('testCondition').value = condition;
            updateMessagePreview(condition);
        }

        function updateCodeCondition() {
            const condition = document.getElementById('conditionCode').value;
            document.getElementById('condition').value = condition;
            document.getElementById('conditionPreview').textContent = condition;
            updateMessagePreview(condition);
        }

        function updateMessagePreview(condition) {
            // This is a simplified preview - in real app you would evaluate the condition
            const payload = {
                id: 141,
                team_id: 40,
                team: {
                    id: 40,
                    name: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
                },
                category: 'incident',
                impact: 'medium',
                subject: '–ù–æ—É—Ç–±—É–∫ CMP00035 –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è',
                requested_by: {
                    name: '–ú–æ–∫–æ—Å–µ–µ–≤–∞ –ö—Å–µ–Ω–∏—è',
                    account: {
                        name: '–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç'
                    }
                },
                note: [{
                    text: 'avwqrgw',
                    person: {
                        name: '–ê—Ñ–∞–Ω–∞—Å–µ–Ω–∫–æ –í–∞–ª–µ—Ä–∏–π'
                    },
                    account: {
                        name: '–ê–û –ü—Ä–æ–ü—Ä–æ–¥—É–∫—Ç'
                    },
                    created_at: '2026-01-07T16:36:27Z'
                }],
                resolution_target_at: '2024-07-29T19:20:00Z',
                response_target_at: '2024-07-26T21:50:00Z'
            };
            
            let message = '';
            
            // ID
            if (payload.id) {
                message += `üÜî ID: ${payload.id}\n\n`;
            }
            
            // Subject
            if (payload.subject) {
                message += `üìã –¢–µ–º–∞: ${payload.subject}\n\n`;
            }
            
            // Requested by
            if (payload.requested_by?.name) {
                const account = payload.requested_by.account?.name || '';
                message += `üë§ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞: ${payload.requested_by.name}${account ? ' @' + account : ''}\n\n`;
            }
            
            // Team, Category, Impact
            if (payload.team?.name) {
                message += `–ö–æ–º–∞–Ω–¥–∞: ${payload.team.name}\n`;
            }
            if (payload.category) {
                message += `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${payload.category}\n`;
            }
            if (payload.impact) {
                message += `–í–ª–∏—è–Ω–∏–µ: ${payload.impact}\n`;
            }
            message += '\n';
            
            // SLA targets
            if (payload.response_target_at || payload.resolution_target_at) {
                if (payload.response_target_at) {
                    try {
                        const date = new Date(payload.response_target_at);
                        if (!isNaN(date.getTime())) {
                            message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞: ${date.toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}\n`;
                        }
                    } catch (e) {
                        message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞: ${payload.response_target_at}\n`;
                    }
                }
                
                if (payload.resolution_target_at) {
                    try {
                        const date = new Date(payload.resolution_target_at);
                        if (!isNaN(date.getTime())) {
                            message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è: ${date.toLocaleString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}\n`;
                        }
                    } catch (e) {
                        message += `‚è∞ –ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ—à–µ–Ω–∏—è: ${payload.resolution_target_at}\n`;
                    }
                }
                message += '\n';
            }
            
            // Notes
            if (payload.note) {
                message += `üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\n`;
                const notes = Array.isArray(payload.note) ? payload.note : [payload.note];
                notes.forEach((note, index) => {
                    const author = note.person?.name || note.person_name || 'Unknown';
                    const account = note.account?.name || note.person?.account?.name || '';
                    const text = note.text || '';
                    let timestamp = '';
                    
                    if (note.created_at) {
                        try {
                            const date = new Date(note.created_at);
                            if (!isNaN(date.getTime())) {
                                timestamp = date.toLocaleString('ru-RU', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            } else {
                                timestamp = note.created_at;
                            }
                        } catch (e) {
                            timestamp = note.created_at;
                        }
                    }
                    
                    message += `${index + 1}. ${author}${account ? ' @' + account : ''}${timestamp ? ' (' + timestamp + ')' : ''}: ${text}\n`;
                });
            }
            
            document.getElementById('messagePreview').innerHTML = message.replace(/\n/g, '<br>');
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch(`${API_BASE}/auth-status`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                const data = await response.json();

                if (data.authenticated) {
                    showMainApp();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                showLoginScreen();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showMainApp();
                } else {
                    showLoginAlert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                showLoginAlert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
            }
        }

        function showLoginScreen() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainApp').style.display = 'none';
        }

        async function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            try {
                const response = await fetch(`${API_BASE}/me`, { headers: getHeaders() });
                if (response.ok) {
                    const data = await response.json();
                    const usernameEl = document.getElementById('currentUsername');
                    if (usernameEl) {
                        usernameEl.textContent = `üë§ ${data.username}`;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –¥–ª—è vadmin
                    const usersTab = document.getElementById('usersTab');
                    const createUserBtn = document.getElementById('createUserBtn');
                    if (usersTab && createUserBtn) {
                        if (data.username === 'vadmin') {
                            usersTab.style.display = 'flex';
                            createUserBtn.style.display = 'flex';
                            loadUsers();
                        } else {
                            usersTab.style.display = 'none';
                            createUserBtn.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
            
            loadRules();
            loadWebhookLogs();
        }

        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.className = `login-alert show alert-${type}`;
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/logout`, { 
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                localStorage.removeItem('authToken');
                authToken = null;
                showLoginScreen();
                document.getElementById('loginForm').reset();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function updateWebhookUrl() {
            const url = `${window.location.origin}/webhook`;
            document.getElementById('webhookUrl').textContent = url;
        }

        async function loadRules() {
            try {
                const response = await fetch(`${API_BASE}/rules`, {
                    headers: getHeaders()
                });
                const rules = await response.json();
                displayRules(rules);
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª: ' + error.message, 'error');
            }
        }

        function renderRuleCard(rule) {
            return `
                <div class="rule-item ${rule.enabled ? '' : 'disabled'}" data-id="${rule.id}">
                    <div class="rule-content">
                        <div class="rule-name">
                            ${rule.enabled ? '‚úÖ' : '‚è∏Ô∏è'} 
                            ${escapeHtml(rule.name)}
                        </div>
                        <div class="rule-condition">${escapeHtml(rule.condition)}</div>
                        <div class="rule-channel">üìç –ö–∞–Ω–∞–ª: <code>${escapeHtml(rule.chatId)}</code></div>
                        ${rule.botToken && typeof rule.botToken === 'string' ? `<div class="rule-bot">ü§ñ –ë–æ—Ç: <code>${escapeHtml(rule.botToken.substring(0, 10))}...</code></div>` : ''}
                        <div class="rule-status">
                            <span class="status-badge ${rule.enabled ? '' : 'disabled'}"></span>
                            ${rule.enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ'}
                        </div>
                    </div>
                    <div class="rule-actions">
                        <button class="btn-primary btn-small" onclick="editRule(${rule.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-danger btn-small" onclick="deleteRule(${rule.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
        }

        function displayRules(rules) {
            const container = document.getElementById('rulesList');
            const searchQuery = document.getElementById('rulesSearch').value.toLowerCase();
            
            const filteredRules = rules.filter(rule => 
                rule.name.toLowerCase().includes(searchQuery) ||
                rule.condition.toLowerCase().includes(searchQuery) ||
                rule.chatId.toString().includes(searchQuery)
            );
            
            if (filteredRules.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 20px;">–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = filteredRules.map(rule => renderRuleCard(rule)).join('');
        }

        function updateRuleCard(updatedRule) {
            const container = document.getElementById('rulesList');
            const ruleElement = container.querySelector(`[data-id="${updatedRule.id}"]`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
            const searchQuery = document.getElementById('rulesSearch').value.toLowerCase();
            const matchesFilter = 
                updatedRule.name.toLowerCase().includes(searchQuery) ||
                updatedRule.condition.toLowerCase().includes(searchQuery) ||
                updatedRule.chatId.toString().includes(searchQuery);
            
            if (!ruleElement) {
                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                if (matchesFilter) {
                    // –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫
                    const noRulesMsg = container.querySelector('p');
                    if (noRulesMsg) {
                        // –ï—Å–ª–∏ –±—ã–ª —Ç–µ–∫—Å—Ç "–ø—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ
                        container.innerHTML = renderRuleCard(updatedRule);
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                        container.insertAdjacentHTML('afterbegin', renderRuleCard(updatedRule));
                    }
                } else {
                    // –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                    // (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ –∏–ª–∏ –µ—â–µ –Ω–µ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ)
                }
                return;
            }
            
            if (matchesFilter) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                ruleElement.outerHTML = renderRuleCard(updatedRule);
            } else {
                // –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                ruleElement.remove();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â–µ –ø—Ä–∞–≤–∏–ª–∞
                const remainingRules = container.querySelectorAll('.rule-item');
                if (remainingRules.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 20px;">–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            }
        }

        function filterRules(query) {
            loadRules();
        }

        async function saveRule(e) {
            e.preventDefault();

            const ruleName = document.getElementById('ruleName').value.trim();
            const condition = document.getElementById('condition').value.trim();
            const chatId = document.getElementById('chatId').value.trim();
            const botToken = document.getElementById('botToken').value.trim();
            const messageTemplate = document.getElementById('messageTemplate').value.trim();
            const enabled = document.getElementById('enabled').checked;

            // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∏–ª–∏ –≤—Å–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
            if (!editingRuleId) {
                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –≤—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
                if (!ruleName || !condition || !chatId || !botToken) {
                    showAlert('addAlert', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∑–≤–∞–Ω–∏–µ, –£—Å–ª–æ–≤–∏–µ, ID –∫–∞–Ω–∞–ª–∞, –¢–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                    return;
                }
            } else {
                // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –ø—É—Å—Ç—ã–µ
                if (!ruleName || !condition || !chatId || !botToken) {
                    showAlert('addAlert', '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏: –ù–∞–∑–≤–∞–Ω–∏–µ, –£—Å–ª–æ–≤–∏–µ, ID –∫–∞–Ω–∞–ª–∞, –¢–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                    return;
                }
            }

            try {
                const method = editingRuleId ? 'PUT' : 'POST';
                const url = editingRuleId 
                    ? `${API_BASE}/rules/${editingRuleId}`
                    : `${API_BASE}/rules`;

                const response = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify({
                        name: ruleName,
                        condition: condition,
                        chatId: chatId,
                        botToken: botToken,
                        messageTemplate: messageTemplate || null,
                        enabled: enabled
                    })
                });

                if (!response.ok) throw new Error('Failed to save rule');

                const savedRule = await response.json();

                showAlert('addAlert', editingRuleId ? '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
                
                if (editingRuleId) {
                    // –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    updateRuleCard(savedRule);
                } else {
                    // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
                    await loadRules();
                }
                
                document.getElementById('ruleForm').reset();
                editingRuleId = null;
                document.querySelector('.card-header h2').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ';
                document.querySelector('#createRuleHeader #toggleCreateRule svg').innerHTML =
                    '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>';
                document.getElementById('createRuleContent').classList.add('collapsed');
                document.getElementById('createRuleContent').style.maxHeight = '0';
                document.querySelector('#createRuleHeader .card-header-icon').style.transform = 'rotate(-90deg)';
            } catch (error) {
                showAlert('addAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function editRule(id) {
            // –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            editingRuleId = id;
            document.querySelector('#createRuleHeader h2').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ';
            
            // –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const content = document.getElementById('createRuleContent');
            const icon = document.querySelector('#createRuleHeader .card-header-icon');
            const button = document.getElementById('toggleCreateRule');
            const arrowSvg = button.querySelector('svg');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                arrowSvg.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
                button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                const ruleForm = document.getElementById('ruleForm');
                ruleForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–æ ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const response = await fetch(`${API_BASE}/rules/${id}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showAlert('addAlert', '–ü—Ä–∞–≤–∏–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                        editingRuleId = null;
                        document.querySelector('#createRuleHeader h2').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ';
                    } else {
                        throw new Error('Failed to load rule');
                    }
                    return;
                }
                
                const rule = await response.json();

                if (!rule) return;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
                document.getElementById('ruleName').value = rule.name || '';
                document.getElementById('chatId').value = rule.chatId || '';
                document.getElementById('botToken').value = rule.botToken || '';
                document.getElementById('messageTemplate').value = rule.messageTemplate || '';
                document.getElementById('enabled').checked = rule.enabled !== false;
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–µ condition –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
                if (rule.condition) {
                    document.getElementById('condition').value = rule.condition;
                }

                // Handle condition mode
                const visualMode = document.querySelector('input[name="conditionMode"][value="visual"]');
                const codeMode = document.querySelector('input[name="conditionMode"][value="code"]');
                
                // Try to parse condition for visual mode
                if (rule.condition.includes('team_id') || rule.condition.includes('team.name') || 
                    rule.condition.includes('category') || rule.condition.includes('impact')) {
                    visualMode.checked = true;
                    document.getElementById('visualConditionEditor').style.display = 'block';
                    document.getElementById('codeConditionEditor').style.display = 'none';
                    
                    try {
                        // Simple parsing for demo purposes
                        const parts = rule.condition.split(/\s*(===|!==|>|<|includes)\s*/);
                        if (parts.length >= 3) {
                            document.querySelector('.field-select').value = parts[0].trim();
                            document.querySelector('.operator-select').value = parts[1].trim();
                            
                            // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                            let rawValue = parts[2].trim().replace(/['"]/g, '');
                            document.querySelector('.value-input').value = rawValue;
                        }
                        updateConditionPreview();
                    } catch (e) {
                        // Fallback to code mode
                        codeMode.checked = true;
                        document.getElementById('visualConditionEditor').style.display = 'none';
                        document.getElementById('codeConditionEditor').style.display = 'block';
                        document.getElementById('conditionCode').value = rule.condition;
                    }
                } else {
                    codeMode.checked = true;
                    document.getElementById('visualConditionEditor').style.display = 'none';
                    document.getElementById('codeConditionEditor').style.display = 'block';
                    document.getElementById('conditionCode').value = rule.condition || '';
                }
                
                // –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º condition –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                if (rule.condition) {
                    document.getElementById('condition').value = rule.condition;
                }
                
                // editingRuleId –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
                document.getElementById('ruleForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                editingRuleId = null;
                document.querySelector('#createRuleHeader h2').textContent = '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ';
                showAlert('addAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤–∏–ª–∞: ' + error.message, 'error');
            }
        }

        async function deleteRule(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ?')) return;

            try {
                const response = await fetch(`${API_BASE}/rules/${id}`, { 
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (!response.ok) throw new Error('Failed to delete rule');

                showAlert('rulesAlert', '–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                await loadRules();
            } catch (error) {
                showAlert('rulesAlert', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message, 'error');
            }
        }

        async function testCondition() {
            const condition = document.getElementById('testCondition').value;
            const payloadStr = document.getElementById('testPayload').value;

            if (!condition || !payloadStr) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ –∏ payload');
                return;
            }

            try {
                const payload = JSON.parse(payloadStr);
                const resultDiv = document.getElementById('testResult');
                resultDiv.innerHTML = `<div class="loading"></div> –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ...`;
                resultDiv.style.display = 'block';
                resultDiv.className = 'test-result';

                // Evaluate condition locally for testing
                try {
                    const fn = new Function('payload', `return ${condition}`);
                    const result = fn(payload);
                    
                    resultDiv.innerHTML = `<strong>‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <strong>${result ? 'TRUE' : 'FALSE'}</strong><br><small>–£—Å–ª–æ–≤–∏–µ: ${escapeHtml(condition)}</small>`;
                    resultDiv.className = `test-result ${result ? 'success' : 'error'}`;
                } catch (evalError) {
                    resultDiv.innerHTML = `<strong>‚úó –û—à–∏–±–∫–∞ –≤ —É—Å–ª–æ–≤–∏–∏:</strong> ${escapeHtml(evalError.message)}`;
                    resultDiv.className = 'test-result error';
                }
            } catch (error) {
                const resultDiv = document.getElementById('testResult');
                resultDiv.innerHTML = `<strong>‚úó –û—à–∏–±–∫–∞:</strong> –ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ payload: ${error.message}`;
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
            }
        }

        async function testTelegramSend() {
            const chatId = document.getElementById('testChatId').value;
            const message = document.getElementById('testMessage').value;
            
            if (!chatId || !message) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID —á–∞—Ç–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            const resultDiv = document.getElementById('telegramTestResult');
            resultDiv.innerHTML = '<div class="loading"></div> –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result';
            
            try {
                const response = await fetch('/api/test-send', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ chatId, message })
                });
                
                const result = await response.json();
                if (result.success) {
                    resultDiv.innerHTML = `‚úÖ <strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</strong> –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ${chatId}.<br><small>Telegram Message ID: ${result.response?.result?.message_id || 'N/A'}</small>`;
                    resultDiv.className = 'test-result success';
                } else {
                    resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong> ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    resultDiv.className = 'test-result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå <strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:</strong> ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function loadWebhookLogs(page = 1) {
            currentPage = page;
            document.getElementById('logsContainer').innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
            document.getElementById('logsContainer').className = 'logs-container skeleton';
            
            try {
                const response = await fetch(`${API_BASE}/webhook-logs`, {
                    headers: getHeaders()
                });
                const logs = await response.json();
                displayWebhookLogs(logs, page);
            } catch (error) {
                document.getElementById('logsContainer').innerHTML = `<p class="log-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</p>`;
                document.getElementById('logsContainer').className = 'logs-container';
            }
        }

        function displayWebhookLogs(logs, page) {
            const container = document.getElementById('logsContainer');
            container.className = 'logs-container';
            
            const startIndex = (page - 1) * logsPerPage;
            const endIndex = Math.min(startIndex + logsPerPage, logs.length);
            const pageLogs = logs.slice(startIndex, endIndex);
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="color: hsl(var(--muted-foreground)); text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                updatePagination(1, 1);
                return;
            }
            
            container.innerHTML = pageLogs.map(log => `
                <div class="log-item">
                    <div class="log-timestamp">${new Date(log.timestamp).toLocaleString('ru-RU')}</div>
                    <strong>–í–µ–±—Ö—É–∫ ID:</strong> <code>${log.id}</code> | 
                    <strong>–°–æ–≤–ø–∞–≤—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞:</strong> ${log.matched} –∏–∑ ${log.total_rules}<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="${log.status === 'matched' ? 'log-success' : 'log-error'}">${log.status === 'matched' ? '‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è' : '‚õî –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π'}</span>
                    <br><br>
                    <strong>–î–∞–Ω–Ω—ã–µ:</strong>
                    <pre class="log-payload">${JSON.stringify(log.payload, null, 2)}</pre>
                    
                    ${log.telegram_results && log.telegram_results.length > 0 ? `
                    <div class="log-telegram">
                        <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.25rem;">
                            ${log.telegram_results.map(result => `
                                <li class="log-telegram-item">
                                    <strong>Chat ID:</strong> ${result.chatId} - 
                                    <span class="${result.success ? 'log-success' : 'log-error'}">
                                        ${result.success ? '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞'}
                                    </span>
                                    ${result.success ? `<br><small>Message ID: ${result.response?.result?.message_id || 'N/A'}</small>` : ''}
                                    ${result.error ? `<br><small>–û—à–∏–±–∫–∞: ${JSON.stringify(result.error)}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `).join('');
            
            const totalPages = Math.ceil(logs.length / logsPerPage);
            updatePagination(page, totalPages);
        }

        function updatePagination(currentPage, totalPages) {
            document.querySelector('.page-info').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
            
            document.querySelector('.prev').disabled = currentPage === 1;
            document.querySelector('.next').disabled = currentPage === totalPages;
            
            document.querySelector('.prev').onclick = () => loadWebhookLogs(currentPage - 1);
            document.querySelector('.next').onclick = () => loadWebhookLogs(currentPage + 1);
        }

        async function clearWebhookLogs() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤–µ–±—Ö—É–∫–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            try {
                const response = await fetch(`${API_BASE}/webhook-logs`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (response.ok) {
                    loadWebhookLogs();
                    showAlert('logsAlert', '–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞', 'success');
                } else {
                    showAlert('logsAlert', '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
                }
            } catch (error) {
                showAlert('logsAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function saveGlobalBotToken() {
            const token = document.getElementById('globalBotToken').value;
            if (!token) {
                showAlert('addAlert', '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                return;
            }
            
            if (token === 'YOUR_TOKEN') {
                showAlert('addAlert', '–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞, –∞ –Ω–µ "YOUR_TOKEN"', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/bot-token', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ botToken: token })
                });
                
                if (response.ok) {
                    showAlert('addAlert', '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    document.getElementById('globalBotToken').value = '***********';
                } else {
                    const error = await response.json();
                    showAlert('addAlert', '–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω'), 'error');
                }
            } catch (error) {
                showAlert('addAlert', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message, 'error');
            }
        }

        async function exportRules() {
            try {
                const response = await fetch('/api/rules', { headers: getHeaders() });
                const rules = await response.json();
                
                if (rules.length === 0) {
                    showAlert('addAlert', '–ù–µ—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                    return;
                }
                
                const dataStr = JSON.stringify(rules, null, 2);
                const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `telegram-webhook-rules-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showAlert('addAlert', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${rules.length} –ø—Ä–∞–≤–∏–ª`, 'success');
            } catch (error) {
                showAlert('addAlert', '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }

        function importRules(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const rules = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(rules)) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                    
                    if (rules.length === 0) {
                        throw new Error('–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª');
                    }
                    
                    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${rules.length} –ø—Ä–∞–≤–∏–ª? –≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞.`)) {
                        return;
                    }
                    
                    // First delete all existing rules
                    const existingRulesResponse = await fetch('/api/rules', { headers: getHeaders() });
                    const existingRules = await existingRulesResponse.json();
                    
                    for (const rule of existingRules) {
                        await fetch(`/api/rules/${rule.id}`, { 
                            method: 'DELETE',
                            headers: getHeaders()
                        });
                    }
                    
                    // Then add the new rules
                    for (const rule of rules) {
                        await fetch('/api/rules', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({
                                name: rule.name,
                                condition: rule.condition,
                                chatId: rule.chatId,
                                botToken: rule.botToken,
                                messageTemplate: rule.messageTemplate || null,
                                enabled: rule.enabled !== false
                            })
                        });
                    }
                    
                    showAlert('addAlert', `–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${rules.length} –ø—Ä–∞–≤–∏–ª`, 'success');
                    await loadRules();
                } catch (error) {
                    showAlert('addAlert', '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset the input for future imports
            document.getElementById('importFile').value = '';
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('button[onclick="copyWebhookUrl()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            if (!alert) return;
            
            alert.textContent = message;
            alert.className = `alert show alert-${type}`;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/[&<>"']/g, m => 
                ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])
            );
        }

        // User management functions
        let currentUserId = null;

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, { headers: getHeaders() });
                if (!response.ok) {
                    if (response.status === 403) {
                        return; // –ù–µ vadmin, –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    }
                    throw new Error('Failed to load users');
                }
                const users = await response.json();
                
                const container = document.getElementById('usersList');
                if (!container) return;
                
                if (users.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px 20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º vadmin –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                const allUsers = [{ id: 'vadmin', username: 'vadmin', created_at: null, isVadmin: true }, ...users];
                
                container.innerHTML = allUsers.map(user => `
                    <div class="rule-item" data-id="${user.id || 'vadmin'}">
                        <div class="rule-content">
                            <div class="rule-name">
                                üë§ ${escapeHtml(user.username)} ${user.isVadmin ? '<span style="color: #667eea;">(vadmin)</span>' : ''}
                            </div>
                            ${user.created_at ? `<div class="rule-channel">üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(user.created_at).toLocaleString('ru-RU')}</div>` : '<div class="rule-channel">üìÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>'}
                        </div>
                        <div class="rule-actions">
                            ${!user.isVadmin ? `<button class="btn-danger btn-small" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                const container = document.getElementById('usersList');
                if (container) {
                    container.innerHTML = `<p style="color: #f44336; text-align: center; padding: 40px 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${error.message}</p>`;
                }
            }
        }

        function showCreateUserForm() {
            document.getElementById('createUserCard').style.display = 'block';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserAlert').className = 'alert';
        }

        function cancelCreateUser() {
            document.getElementById('createUserCard').style.display = 'none';
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserAlert').className = 'alert';
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!username || !password) {
                showAlert('createUserAlert', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    showAlert('createUserAlert', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
                    document.getElementById('createUserForm').reset();
                    setTimeout(() => {
                        cancelCreateUser();
                        loadUsers();
                    }, 1500);
                } else {
                    const data = await response.json();
                    showAlert('createUserAlert', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('createUserAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        async function deleteUser(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showAlert('usersAlert', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                    loadUsers();
                } else {
                    const data = await response.json();
                    showAlert('usersAlert', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('usersAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // Change password functions
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordAlert').className = 'alert';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordAlert').className = 'alert';
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('changePasswordAlert', '–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
                const meResponse = await fetch(`${API_BASE}/me`, { headers: getHeaders() });
                if (!meResponse.ok) throw new Error('Failed to get current user');
                const meData = await meResponse.json();
                
                // –î–ª—è vadmin —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                if (meData.username === 'vadmin') {
                    showAlert('changePasswordAlert', '–î–ª—è vadmin —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.', 'error');
                    return;
                }
                
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º userId –∏–∑ –æ—Ç–≤–µ—Ç–∞ /api/me
                const userId = meData.userId;
                if (!userId) {
                    showAlert('changePasswordAlert', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/users/${userId}/password`, {
                    method: 'PUT',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        oldPassword: meData.username === 'vadmin' ? undefined : oldPassword,
                        password: newPassword 
                    })
                });
                
                if (response.ok) {
                    showAlert('changePasswordAlert', '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 1500);
                } else {
                    const data = await response.json();
                    showAlert('changePasswordAlert', data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
                }
            } catch (error) {
                showAlert('changePasswordAlert', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>